<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Valkhof Festival 2025</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 183.57 183.57'%3E %3Ccircle cx='91.785' cy='91.785' r='91.785' fill='%23cccccc'/%3E %3Cg%3E %3CanimateTransform attributeName='transform' type='rotate' from='0 91.785 91.785' to='360 91.785 91.785' dur='20s' repeatCount='indefinite'/%3E %3C!-- Deze groep schaalt de inhoud naar 75%25 en centreert het --%3E %3Cg transform='translate(49.63 22.946) scale(0.75)'%3E %3Cpath d='M108.8,110.688C105.213,101.053,96.864,95.578,90,88.321c-4.033-3.574-6.292-12.874,1.639-11.685A20.888,20.888,0,0,0,103.4,73.843c5.389-2.751,9.114-8.309,8.615-14.412-.486-10.01-1.075-20.046-1.325-30.1.007-8.512,3.283-22.539-5.486-27.327C95.353-1.656,77.637-1.107,73.58,10.488c-1.121,2.678-1.149,7.1-1.332,9.975C71.9,25.827,70.67,32.97,71.2,38.292a71.336,71.336,0,0,1,.345,11.66c-2.107,8.747-2.179,21.282-10.495,25.79-4.39,2.541-8.939-.535-11.858-3.763C38.829,61.523,41.34,47.44,41.481,34.048c-.935-9.821-.563-22.691-8.531-29.624C20.594-2.774,2.212,1.759.441,17.785c-1.339,8.288.8,16.256.764,24.43C1.382,48.9.428,55.675.729,62.387a33.405,33.405,0,0,0,13.735,25.97c5.3,3.812,14.125,9.972,10.472,17.542a2.735,2.735,0,0,1-2.673,1.188c-8.242-.268-16.854,4.785-19.416,12.788-1.41,5.975-.4,11.535-.663,17.744,1.7,13.593-7.3,32.231,4.366,42.764,4.615,2.346,10.127.9,15,.568,34.144,1.983,10.9-40.864,22.178-58.377,3.64-4.847,6.148-9.354,11.483-12.369,1.8-1.04,3.432-2.822,5.659-2.079,12.326,4.636,11.158,20.592,10.508,31.389-.86,16.967-5.224,49.528,21.752,43.265,3.717-.242,7.533-.7,10.511-2.94,14.575-11.272,6-31.043,8.457-46.518.119-7.668-.327-15.458-3.293-22.635m-4.458,60.358c-9.286,7.154-23.38,6.2-24.661-7.566-.087-14.111-.1-28.407-2.788-42.366-2.2-10.083-11.858-24.873-23.139-18.716C48.162,105.731,43,115.276,38.729,119.723a20.352,20.352,0,0,0-3.345,8.022c-2.05,12.7,3.861,25.376-.921,37.851-1.457,4.234-4.616,8.449-9.091,9.658-4.993,1.271-10.991,1.953-15.572-.7a6.363,6.363,0,0,1-1.99-4.008c-1.992-9.033.271-17.181.87-26.169.266-5.245-.348-11.268-.167-16.431-1.184-19.046,18.08-9.94,26.667-18.929,5.407-6.926-1.258-15.1-7.282-18.869C11.627,83.277,1.071,69.16,7.941,51.259a82.764,82.764,0,0,0,.552-24.643c-.5-3.469-.716-7.948.193-11.388a22.958,22.958,0,0,1,1.7-4.243,6.267,6.267,0,0,1,1.291-1.937,5.151,5.151,0,0,1,3.3-1.1c2.135-.088,5.573-.483,7.519.641C43.7,20.842,26.924,52.5,40.722,69.421,57.7,96.5,78.189,72.668,78.56,50.261c1.467-11.189-3.79-23.1-.922-33.979,2.516-8.617,12.7-11.927,20.945-10.459,15.171,4.31,4.738,24.625,6.1,35.611-.467,10.144,1.482,24.84-10.712,28.7-3.724,1.2-8.091.164-11.514,2.4C76,77.266,78.878,86.438,83.518,91.3c9.354,11.344,20.159,17.059,20.544,33.431.388,11.8-.954,23.364,2.242,35.067.983,3.769.588,8.185-1.959,11.248' fill='%23000000'/%3E %3C/g%3E %3C/g%3E %3C/svg%3E" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
html {
    overflow-y: scroll;
}
*, *:before, *:after {
    box-sizing: border-box;
}

body {
font-family: Arial, sans-serif;
margin: 0;
padding-left: 10px;
padding-right: 10px;
padding-bottom: 10px;
background: #f0f0f0;
}

.control-bar-group {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: #f0f0f0;
    padding: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: transform 0.3s ease-out;
    will-change: transform;
}

.control-bar-group.hidden {
    transform: translateY(-100%);
}

.day-filter-container,
.filter-container {
    margin-bottom: 5px;
}

.day-filter-container {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 5px;
}
.day-filter-button {
padding: 10px;
font-size: 14px;
text-align: center;
background: #ddd;
border: none;
cursor: pointer;
border-radius: 4px;
}
.day-filter-button.active {
background: #007bff;
color: #fff;
}
.filter-container {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 5px;
}
.filter-button, #searchField {
padding: 10px;
font-size: 14px;
text-align: center;
background: #fff;
border: 1px solid #ddd;
border-radius: 20px;
cursor: pointer;
}
.filter-button.active {
background: #007bff;
color: #fff;
}
#searchField {
width: 100%;
}
#searchField::-webkit-search-decoration,
#searchField::-webkit-search-cancel-button,
#searchField::-webkit-search-results-button,
#searchField::-webkit-search-results-decoration {
    -webkit-appearance:none;
    display: none;
}
#searchField::-ms-clear {
    display: none;
    width: 0;
    height: 0;
}
#searchField:focus {
outline: none;
border-color: #007bff;
}
#searchField.has-content {
background: #007bff;
color: #fff;
}
.info-container {
background: #fff;
border-radius: 4px;
padding: 0 15px;
display: flex;
align-items: center;
box-shadow: 0 1px 3px rgba(0,0,0,0.1);
height: 40px;
margin-bottom: 0;
}
#countText {
font-weight: bold;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
min-width: 0;
margin-right: 10px;
}
.icons-group {
margin-left: auto;
display: flex;
gap: 10px;
align-items: center;
}
.icons-group .material-icons {
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
    font-size: 22px;
}
.icons-group.loaded .material-icons {
    opacity: 1;
}

.sort-icon, .favorite-toggle {
cursor: pointer;
color: #555;
user-select: none;
font-display: block;
}
.sort-icon.active {
color: #007bff;
}
.favorite-toggle {
color: red;
}
#errorMessage {
display: none;
color: #a00;
background: #fdd;
padding: 10px;
border: 1px solid #a00;
border-radius: 5px;
margin-bottom: 10px;
}
#artistList {
display: flex;
flex-direction: column;
gap: 10px;
}
.artist-card {
background: #fff;
border-radius: 8px;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
padding: 15px;
position: relative;
}
.artist-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.artist-card h2 {
margin: 0;
font-size: 20px;
}
.favorite-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: red;
    font-display: block;
    margin-left: 10px;
    flex-shrink: 0;
}

.artist-photo {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 15px;
    background-color: #e0e0e0;
}

.artist-meta-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
}

.artist-info,
.artist-description {
font-size: 14px;
line-height: 1.4;
}
.artist-info p,
.artist-description p {
margin: 6px 0;
}
.artist-info {
    margin: 0;
    flex-grow: 1;
}
.artist-description {
    margin-top: 15px;
}

.artist-name {
color: #007bff;
text-decoration: none;
}

.artist-info p:first-child {
margin-top: 0;
}

mark {
    background-color: yellow;
    color: black;
    padding: 0.1em;
    border-radius: 3px;
}

.youtube-links-container {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #eee;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.youtube-link-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    text-decoration: none;
    background-color: #f9f9f9;
    padding: 8px;
    border-radius: 6px;
    transition: background-color 0.2s;
}
.youtube-link-item:hover {
    background-color: #efefef;
}

.youtube-thumbnail {
    width: 120px;
    height: 67px;
    object-fit: cover;
    border-radius: 4px;
    flex-shrink: 0;
}

.youtube-title {
    font-size: 13px;
    line-height: 1.4;
    color: #333;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
}

.spotify-buttons-container {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
}

.spotify-open-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    background-color: #1DB954;
    color: white !important;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    text-decoration: none;
    transition: background-color 0.2s;
}
.spotify-open-button:hover {
    background-color: #1ed760;
}
.spotify-open-button i {
    font-size: 16px;
}

.spotify-play-button {
    background-color: #1DB954;
    color: white !important;
    border: none;
    padding: 8px 12px 8px 10px;
    border-radius: 50px;
    cursor: pointer;
    font-size: 13px;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    text-decoration: none;
    transition: background-color 0.2s;
    flex-shrink: 0;
}
.spotify-play-button:hover {
    background-color: #1ed760;
}
.spotify-play-button i {
    margin-right: 8px;
    font-size: 18px;
}

.docked-spotify-player-wrapper {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 80px;
    z-index: 2000;
    display: flex;
    align-items: center;
    background-color: #282828;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
    transition: transform 0.3s ease-in-out;
    will-change: transform;
    transform: translateY(100%) translateZ(0); /* Start met 3D transform */
}

.docked-spotify-player-wrapper.visible {
    transform: translateY(0) translateZ(0); /* Behoud 3D transform */
}

.docked-spotify-player-container {
    flex-grow: 1;
    height: 100%;
    padding: 0;
}

#docked-spotify-iframe {
    width: 100%;
    height: 100%;
    display: block;
    border: none;
}

#closeDockedPlayerButton {
    flex-shrink: 0;
    background: transparent;
    color: white;
    border: none;
    width: 44px;
    height: 100%;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 10px;
}
#closeDockedPlayerButton:hover {
    background: rgba(255,255,255,0.1);
}


body.dark-mode {
background: #282c34;
color: #abb2bf;
}
body.dark-mode .control-bar-group {
    background: #282c34;
    box-shadow: 0 2px 5px rgba(0,0,0,0.4);
}
body.dark-mode .day-filter-button,
body.dark-mode .filter-button,
body.dark-mode #searchField {
background: #4b5059;
color: #c6cdd5;
border-color: #5b6069;
}
body.dark-mode .day-filter-button.active,
body.dark-mode .filter-button.active {
background: #61afef;
color: #282c34;
}
body.dark-mode #searchField::placeholder {
color: #98a0ad;
}
body.dark-mode #searchField.has-content {
background: #61afef;
color: #282c34;
}
body.dark-mode .info-container {
    background: #3b4048;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
body.dark-mode .artist-card {
background: #3b4048;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
body.dark-mode .artist-photo {
    background-color: #4b5059;
}
body.dark-mode .artist-name {
color: #61afef;
}
body.dark-mode .sort-icon, body.dark-mode .favorite-toggle {
color: #abb2bf;
}
body.dark-mode .sort-icon.active {
color: #61afef;
}
body.dark-mode .favorite-toggle, body.dark-mode .favorite-icon {
color: #e06c75;
}
body.dark-mode #errorMessage {
color: #e06c75;
background: #4b3030;
border-color: #c05050;
}
body.dark-mode .info-container #countText {
color: inherit;
}
body.dark-mode .artist-card h2 {
color: inherit;
}
body.dark-mode mark {
    background-color: #61afef;
    color: #282c34;
}
body.dark-mode .youtube-links-container {
    border-top-color: #4b5059;
}
body.dark-mode .youtube-link-item {
    background-color: #353a40;
}
body.dark-mode .youtube-link-item:hover {
    background-color: #40454c;
}
body.dark-mode .youtube-thumbnail {
}
body.dark-mode .youtube-title {
    color: #c6cdd5;
}
.material-icons {
    font-display: block;
}
body.dark-mode .docked-spotify-player-wrapper {
    background-color: #181818;
}
body.dark-mode #closeDockedPlayerButton {
    color: #abb2bf;
}
body.dark-mode #closeDockedPlayerButton:hover {
    background: rgba(255,255,255,0.05);
}

</style>
</head>
<body class="dark-mode">

<div id="controlBarGroup" class="control-bar-group">
    <div class="day-filter-container">
    <button class="day-filter-button" data-dayfilter="12 juli">Za</button>
    <button class="day-filter-button" data-dayfilter="13 juli">Zo</button>
    <button class="day-filter-button" data-dayfilter="14 juli">Ma</button>
    <button class="day-filter-button" data-dayfilter="15 juli">Di</button>
    <button class="day-filter-button" data-dayfilter="16 juli">Wo</button>
    <button class="day-filter-button" data-dayfilter="17 juli">Do</button>
    <button class="day-filter-button" data-dayfilter="18 juli">Vr</button>
    </div>

    <div class="filter-container">
    <button class="filter-button" data-podium="Arc">Arc</button>
    <button class="filter-button" data-podium="Boog">Boog</button>
    <button class="filter-button" data-podium="Bloem">Bloem</button>
    <button class="filter-button" data-podium="Club Voerweg">Voerweg</button>
    <button class="filter-button" data-podium="Tuin">Tuin</button>
    <button class="filter-button" data-podium="Kapel">Kapel</button>
    <button class="filter-button" data-podium="Poort">Poort</button>
    <input type="search" id="searchField" placeholder="Zoek.." autocomplete="off">
    </div>

    <div class="info-container">
    <span id="countText">0 artiesten gevonden</span>
    <span class="icons-group">
    <span id="sortAlpha" class="sort-icon material-icons" title="Alfabetisch sorteren">sort_by_alpha</span>
    <span id="sortTime" class="sort-icon material-icons" title="Sorteren op tijd">access_time</span>
    <span id="favoriteToggle" class="favorite-toggle material-icons" title="Toon favorieten">favorite_border</span>
    </span>
    </div>
</div>

<div id="errorMessage"></div>
<div id="artistList"></div>

<div id="dockedSpotifyPlayerWrapper" class="docked-spotify-player-wrapper">
    <div id="dockedSpotifyPlayerContainer" class="docked-spotify-player-container">
    </div>
    <button id="closeDockedPlayerButton" class="material-icons" title="Sluit player">close</button>
</div>

<script>
(function(){
const CORS_PROXY = 'https://api.codetabs.com/v1/proxy?quest=',
BASE_URL = 'https://valkhoffestival.nl',
WEEK_URL = BASE_URL + '/lineup/',
PREFIX = 'vf_',
ALL_ARTISTS_DATA_CACHE_VERSION_SUFFIX = '_v5',
ALL_ARTISTS_DATA_CACHE_KEY = PREFIX + 'allArtistsData' + ALL_ARTISTS_DATA_CACHE_VERSION_SUFFIX,
ALL_ARTISTS_DATA_TIMESTAMP_KEY = PREFIX + 'allArtistsData_timestamp' + ALL_ARTISTS_DATA_CACHE_VERSION_SUFFIX,
CACHE_MAX_AGE_MS = 60 * 60 * 1000;

const artistListElement = document.getElementById('artistList'),
countTextElement = document.getElementById('countText'),
errorMessageElement = document.getElementById('errorMessage'),
searchFieldElement = document.getElementById('searchField'),
sortAlphaElement = document.getElementById('sortAlpha'),
sortTimeElement = document.getElementById('sortTime'),
favoriteToggleElement = document.getElementById('favoriteToggle'),
dayFilterContainerElement = document.querySelector('.day-filter-container'),
filterContainerElement = document.querySelector('.filter-container'),
controlBarGroup = document.getElementById('controlBarGroup'),
iconsGroupElement = document.querySelector('.icons-group'),
dockedSpotifyPlayerWrapper = document.getElementById('dockedSpotifyPlayerWrapper'),
dockedSpotifyPlayerContainer = document.getElementById('dockedSpotifyPlayerContainer'),
closeDockedPlayerButton = document.getElementById('closeDockedPlayerButton');

const isAndroidDevice = /android/i.test(navigator.userAgent);

let lastScrollY = window.scrollY;
let ticking = false;

let allArtistsData = [],
searchClickShouldClear = false;

const dagen = ['zondag','maandag','dinsdag','woensdag','donderdag','vrijdag','zaterdag'];
const originalHTMLMap = new WeakMap();

function getStoredJSON(keySuffix, defaultValue) {
const item = localStorage.getItem(keySuffix);
if (item === null) return defaultValue;
try {
return JSON.parse(item);
} catch (e) {
console.warn(`Failed to parse ${keySuffix} from localStorage.`, e);
localStorage.removeItem(keySuffix);
return defaultValue;
}
}

function setStoredJSON(keySuffix, value) {
localStorage.setItem(keySuffix, JSON.stringify(value));
}

function getStoredString(keySuffix, defaultValue) {
const item = localStorage.getItem(PREFIX + keySuffix);
return item === null ? defaultValue : item;
}

function setStoredString(keySuffix, value) {
localStorage.setItem(PREFIX + keySuffix, value);
}

let sortMode = getStoredString('sortMode', 'time'),
activePodia = getStoredJSON(PREFIX + 'activePodia', []),
favorites = getStoredJSON(PREFIX + 'favorites', []),
showingFavs = getStoredJSON(PREFIX + 'showingFavs', false),
activeDays = getStoredJSON(PREFIX + 'activeDays', []);

function capitalize(s){
if(!s) return s;
return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
}

function showError(msg){
errorMessageElement.textContent = msg;
errorMessageElement.style.display = 'block';
}
function hideError(){
errorMessageElement.style.display = 'none';
}
function getFullUrl(url){
return url.startsWith('http')
? url
: BASE_URL + (url.startsWith('/') ? '' : '/') + url;
}

async function fetchArtistInfo(artistBasicInfo) {
    const artistCacheKey = PREFIX + 'artist_info_' + artistBasicInfo.name.replace(/[^a-zA-Z0-9]/g, '_') + '_v2';
    const stored = localStorage.getItem(artistCacheKey);
    if (stored) {
        try {
            const infoData = JSON.parse(stored);
            const isNewStructure = infoData.youtubeLinks && infoData.youtubeLinks.length > 0 ?
                                   typeof infoData.youtubeLinks[0].videoId !== 'undefined' :
                                   true; 

            if (isNewStructure) {
                return infoData;
            } else {
                console.warn(`Cached artist info for ${artistBasicInfo.name} (key ${artistCacheKey}) has old structure. Refetching.`);
                localStorage.removeItem(artistCacheKey);
            }
        } catch (e) {
            console.warn(`Failed to parse cached artist info for ${artistBasicInfo.name} (key ${artistCacheKey}). Refetching.`, e);
            localStorage.removeItem(artistCacheKey);
        }
    }

    try {
        const res = await fetch(CORS_PROXY + artistBasicInfo.artistUrl);
        if (!res.ok) return null;
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const tags = Array.from(doc.querySelectorAll('.meta .tag'));
        const paras = doc.querySelectorAll('.description p');

        const spotifyIframe = doc.querySelector('.spotify iframe');
        let spotifyId = null;
        if (spotifyIframe) {
            const src = spotifyIframe.getAttribute('src');
            if (src) {
                const match = src.match(/spotify:artist:([^&?]+)/) || src.match(/embed\/artist\/([^&?]+)/);
                if (match && match[1]) spotifyId = match[1];
            }
        }

        const youtubeIframes = doc.querySelectorAll('figure.wp-block-embed.is-provider-youtube iframe');
        let youtubeLinks = [];
        if (youtubeIframes.length > 0) {
            youtubeIframes.forEach(iframe => {
                const src = iframe.getAttribute('src');
                const title = iframe.getAttribute('title');
                if (src && title) {
                    const videoIdMatch = src.match(/embed\/([^?]+)/);
                    if (videoIdMatch && videoIdMatch[1]) {
                        const videoId = videoIdMatch[1];
                        youtubeLinks.push({
                            url: `https://www.youtube.com/watch?v=${videoId}`,
                            title: title,
                            videoId: videoId
                        });
                    }
                }
            });
        }

        const rawPodium = tags[tags.length - 3]?.textContent.trim() || 'Onbekend';
        const rawDatum = tags[tags.length - 2]?.textContent.trim() || 'Onbekend';
        const rawTijd = tags[tags.length - 1]?.textContent.trim() || 'Onbekend';

        let duurTekst = '';
        if (rawTijd.includes('-')) {
            const [start, end] = rawTijd.split('-').map(s => s.trim());
            const [su, sm] = start.split(':').map(n => parseInt(n, 10));
            const [eu, em] = end.split(':').map(n => parseInt(n, 10));
            if (!isNaN(su) && !isNaN(sm) && !isNaN(eu) && !isNaN(em)) {
                let minutesStart = su * 60 + sm;
                let minutesEnd = eu * 60 + em;
                if (minutesEnd <= minutesStart) minutesEnd += 24 * 60;
                const diff = minutesEnd - minutesStart;
                if (diff > 0 && diff <= 24 * 60) duurTekst = diff + ' min';
            }
        }

        const info = {
            genres: tags.slice(0, -3).map(t => t.textContent.trim()),
            podium: capitalize(rawPodium),
            datum: rawDatum,
            tijd: rawTijd,
            duur: duurTekst,
            description: Array.from(paras).map(p => p.innerHTML.trim()).filter(html => html).join('\n\n') || 'Geen beschrijving beschikbaar',
            spotifyId: spotifyId,
            youtubeLinks: youtubeLinks
        };
        localStorage.setItem(artistCacheKey, JSON.stringify(info));
        return info;
    } catch (err) {
        console.error(`Error fetching info for ${artistBasicInfo.name}:`, err);
        return null;
    }
}

async function loadAllArtistsData() {
    hideError();

    const cachedDataTimestamp = getStoredJSON(ALL_ARTISTS_DATA_TIMESTAMP_KEY, 0);
    if (Date.now() - cachedDataTimestamp > CACHE_MAX_AGE_MS) {
        console.warn(`Cache for ${ALL_ARTISTS_DATA_CACHE_KEY} is older than 1 hour. Invalidating.`);
        localStorage.removeItem(ALL_ARTISTS_DATA_CACHE_KEY);
        localStorage.removeItem(ALL_ARTISTS_DATA_TIMESTAMP_KEY);
    }

    const cachedData = localStorage.getItem(ALL_ARTISTS_DATA_CACHE_KEY);
    if (cachedData) {
        try {
            let parsedAllArtistsData = JSON.parse(cachedData);
            if (parsedAllArtistsData.length > 0 && typeof parsedAllArtistsData[0].artist.imageUrl === 'undefined') {
                 console.warn(`Cache for ${ALL_ARTISTS_DATA_CACHE_KEY} has old structure (missing imageUrl). Invalidating.`);
                 localStorage.removeItem(ALL_ARTISTS_DATA_CACHE_KEY);
                 localStorage.removeItem(ALL_ARTISTS_DATA_TIMESTAMP_KEY);
            } else {
                allArtistsData = parsedAllArtistsData;
                console.log(`All artists data loaded from cache (key: ${ALL_ARTISTS_DATA_CACHE_KEY}).`);
                return;
            }
        } catch (e) {
            console.warn(`Failed to parse ${ALL_ARTISTS_DATA_CACHE_KEY} from cache, fetching fresh.`, e);
            localStorage.removeItem(ALL_ARTISTS_DATA_CACHE_KEY);
            localStorage.removeItem(ALL_ARTISTS_DATA_TIMESTAMP_KEY);
        }
    }
    
    allArtistsData = [];
    countTextElement.textContent = 'Artiesten laden...';
    try {
        const res = await fetch(CORS_PROXY + WEEK_URL);
        if (!res.ok) {
            showError(`Kon basis artiestenlijst niet laden (status ${res.status}).`);
            return;
        }
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');

        const urlRegex = /url\('([^']+)'\)/;

        const artistBasicInfos = Array.from(doc.querySelectorAll('a.artist'))
            .map(a => {
                const name = a.querySelector('.nameplate h2').textContent.trim();
                const artistUrl = getFullUrl(a.getAttribute('href'));
                
                const innerDiv = a.querySelector('.artist-inner');
                const styleAttr = innerDiv?.getAttribute('style');
                const styleMatch = styleAttr ? styleAttr.match(urlRegex) : null;
                const imageUrl = styleMatch && styleMatch[1] ? getFullUrl(styleMatch[1]) : null;

                return { name, artistUrl, imageUrl };
            });
        
        const newAllArtistsData = [];
        let fetchedCount = 0;
        for (const basicInfo of artistBasicInfos) {
            const info = await fetchArtistInfo(basicInfo);
            newAllArtistsData.push({
                artist: basicInfo,
                info: info || {
                    genres: [], podium: 'Onbekend', datum: 'Onbekend', tijd: 'Onbekend',
                    duur: '', description: 'Details konden niet geladen worden.', spotifyId: null,
                    youtubeLinks: [] 
                }
            });
            fetchedCount++;
            countTextElement.textContent = `Details geladen voor ${fetchedCount}/${artistBasicInfos.length} artiesten...`;
        }

        allArtistsData = newAllArtistsData;
        localStorage.setItem(ALL_ARTISTS_DATA_CACHE_KEY, JSON.stringify(allArtistsData));
        setStoredJSON(ALL_ARTISTS_DATA_TIMESTAMP_KEY, Date.now());
        console.log(`All artists data fetched and cached (key: ${ALL_ARTISTS_DATA_CACHE_KEY}).`);

    } catch (err) {
        console.error("Error during fetch of all artists data:",err);
        showError('Netwerkfout bij ophalen artiestenlijst.');
    }
}

function parseDateTimeForSort(datum, tijd){
if (!datum || !tijd || datum === 'Onbekend' || tijd === 'Onbekend' || !tijd.includes(':')) return 0;

const datumParts = datum.split(' ');
if (datumParts.length < 2) return 0;
const dagNum = parseInt(datumParts[0], 10);

const startTimeStr = tijd.split('-')[0].trim();
const tijdParts = startTimeStr.split(':');
if (tijdParts.length < 2) return 0;

const u = parseInt(tijdParts[0], 10);
const m = parseInt(tijdParts[1], 10);

if (isNaN(dagNum) || isNaN(u) || isNaN(m)) return 0;
return new Date(2025, 6, dagNum, u, m).getTime();
}

function renderAllArtistCardsOnce() {
artistListElement.innerHTML = '';

allArtistsData.forEach(({ artist, info }) => {
const card = document.createElement('div');
card.className = 'artist-card';
card.style.display = 'none';

card.dataset.name = artist.name.toLowerCase();
card.dataset.podium = info.podium;
card.dataset.dag = info.datum;
card.dataset.tijdInfo = info.tijd;
card.dataset.timestamp = parseDateTimeForSort(info.datum, info.tijd);
card.dataset.rawName = artist.name;
card.dataset.genres = info.genres.join(',').toLowerCase();
card.dataset.description = info.description.replace(/<[^>]*>/g, ' ').toLowerCase();
if (info.spotifyId) {
    card.dataset.spotifyId = info.spotifyId;
}

const placeholderImgUrl = `https://placehold.co/300x300/e0e0e0/777?text=Foto`;
const imgSrc = artist.imageUrl || placeholderImgUrl;
const transparentPixel = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

const dagNum = info.datum !== 'Onbekend' ? info.datum.split(' ')[0].padStart(2, '0') : '';
let dagNaam = '';
if (dagNum) {
    const date = new Date(2025, 6, parseInt(dagNum, 10));
    if (!isNaN(date.getTime())) {
        dagNaam = dagen[date.getDay()];
    }
}

const isFav = favorites.includes(artist.name);

let spotifyControlsHtml = '';
if (info.spotifyId) {
    spotifyControlsHtml = `
    <div class="spotify-buttons-container">
        <a href="spotify:artist:${info.spotifyId}" class="spotify-open-button" title="Open in Spotify" target="_blank">
            <i class="fa-solid fa-up-right-from-square"></i>
        </a>
        <button class="spotify-play-button" data-spotify-id="${info.spotifyId}">
            <i class="fa-brands fa-spotify"></i> Preview
        </button>
    </div>`;
}

let youtubeLinksHtml = '';
if (info.youtubeLinks && info.youtubeLinks.length > 0) {
    youtubeLinksHtml = '<div class="youtube-links-container">';
    info.youtubeLinks.forEach(ytLink => {
        if (ytLink.videoId) {
            const thumbnailUrl = `https://img.youtube.com/vi/${ytLink.videoId}/mqdefault.jpg`;
            const linkUrl = isAndroidDevice ? `vnd.youtube:${ytLink.videoId}` : ytLink.url;
            const linkTarget = isAndroidDevice ? '' : 'target="_blank"';
            youtubeLinksHtml += `
                <a href="${linkUrl}" ${linkTarget} class="youtube-link-item">
                    <img data-src="${thumbnailUrl}" src="${transparentPixel}" alt="Thumbnail: ${ytLink.title}" class="youtube-thumbnail lazyload">
                    <span class="youtube-title">${ytLink.title}</span>
                </a>`;
        }
    });
    youtubeLinksHtml += '</div>';
}

card.innerHTML = `
<div class="artist-header">
    <h2><a href="${artist.artistUrl}" target="_blank" class="artist-name">${artist.name}</a></h2>
    <span class="favorite-icon material-icons" data-name="${artist.name}">
        ${isFav ? 'favorite' : 'favorite_border'}
    </span>
</div>
<img data-src="${imgSrc}" src="${transparentPixel}" alt="Foto van ${artist.name}" class="artist-photo lazyload">
<div class="artist-meta-container">
    <div class="artist-info">
        <p class="highlightable-genres"><strong>Genre:</strong> ${info.genres.join(', ') || 'Geen genres'}</p>
        <p class="highlightable-podium"><strong>Podium:</strong> ${info.podium}</p>
        <p><strong>Datum:</strong> ${dagNaam ? capitalize(dagNaam) + ' ' : ''}${info.datum}</p>
        <p><strong>Tijd:</strong> ${info.tijd}${info.duur ? ' (' + info.duur + ')' : ''}</p>
    </div>
    ${spotifyControlsHtml}
</div>
<div class="artist-description highlightable-description">
    <p>${info.description.replace(/\n\n/g, '</p><p>')}</p>
</div>
${youtubeLinksHtml}`;
artistListElement.appendChild(card);
});
}


function setupImageLazyLoader() {
    const lazyImages = document.querySelectorAll('img.lazyload[data-src]');
    if ('IntersectionObserver' in window) {
        let imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const image = entry.target;
                    image.src = image.dataset.src;
                    image.classList.remove('lazyload');
                    imageObserver.unobserve(image);
                }
            });
        }, { rootMargin: '200px 0px 200px 0px' });
        lazyImages.forEach(image => imageObserver.observe(image));
    } else {
        lazyImages.forEach(image => {
            image.src = image.dataset.src;
            image.classList.remove('lazyload');
        });
    }
}

function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function clearHighlight(element) {
    if (element && originalHTMLMap.has(element)) {
        element.innerHTML = originalHTMLMap.get(element);
    }
}

function applyHighlight(element, searchTerm) {
    if (!element) return;

    if (!originalHTMLMap.has(element)) {
        originalHTMLMap.set(element, element.innerHTML);
    }
    
    element.innerHTML = originalHTMLMap.get(element); 

    if (!searchTerm) {
        return;
    }
    
    const escapedSearchTerm = escapeRegExp(searchTerm);
    const regex = new RegExp(escapedSearchTerm, 'gi');

    function highlightNodeRecursive(node) {
        if (node.nodeType === Node.TEXT_NODE) {
            const text = node.nodeValue;
            if (regex.test(text)) {
                const fragment = document.createDocumentFragment();
                let lastIndex = 0;
                text.replace(regex, (match, ...args) => {
                    const offset = args[args.length - 2]; 
                    if (offset > lastIndex) {
                        fragment.appendChild(document.createTextNode(text.substring(lastIndex, offset)));
                    }
                    const mark = document.createElement('mark');
                    mark.textContent = match;
                    fragment.appendChild(mark);
                    lastIndex = offset + match.length;
                    return match; 
                });
                if (lastIndex < text.length) {
                    fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                }
                if (fragment.childNodes.length > 0) {
                    node.parentNode.replaceChild(fragment, node);
                }
            }
        } else if (node.nodeType === Node.ELEMENT_NODE) {
            if (node.tagName.toLowerCase() === 'mark' || node.tagName.toLowerCase() === 'script' || node.tagName.toLowerCase() === 'style') {
                return; 
            }
            Array.from(node.childNodes).forEach(highlightNodeRecursive);
        }
    }
    highlightNodeRecursive(element);
}

function scrollToArtistListTop() {
    if (!artistListElement || !controlBarGroup) return;

    window.scrollTo({
        top: 0,
        behavior: 'auto'
    });

    if (controlBarGroup) {
        controlBarGroup.classList.remove('hidden');
    }
    lastScrollY = 0;
}

function applyFiltersAndSort(options = {}) {
hideError();
const searchTerm = searchFieldElement.value.toLowerCase();
let visibleCount = 0;

const cardElements = artistListElement.children;

for (const card of cardElements) {
    const { name: artistNameLC, podium, dag, genres, description, rawName } = card.dataset;

    const artistNameEl = card.querySelector('.artist-name');
    const genresEl = card.querySelector('.highlightable-genres');
    const podiumEl = card.querySelector('.highlightable-podium');
    const descriptionEl = card.querySelector('.highlightable-description');
    
    clearHighlight(artistNameEl);
    clearHighlight(genresEl);
    clearHighlight(podiumEl);
    clearHighlight(descriptionEl);

    const matchesDay = !activeDays.length || activeDays.includes(dag);
    const matchesPodium = !activePodia.length || activePodia.includes(podium);
    const matchesSearch = !searchTerm ||
    artistNameLC.includes(searchTerm) ||
    description.includes(searchTerm) ||
    genres.includes(searchTerm) ||
    podium.toLowerCase().includes(searchTerm);
    const matchesFavs = !showingFavs || favorites.includes(rawName);

    if (matchesDay && matchesPodium && matchesSearch && matchesFavs) {
        card.style.display = '';
        visibleCount++;
        if (searchTerm) {
            applyHighlight(artistNameEl, searchTerm);
            if (genresEl && genresEl.textContent.toLowerCase().includes(searchTerm)) applyHighlight(genresEl, searchTerm);
            if (podiumEl && podiumEl.textContent.toLowerCase().includes(searchTerm)) applyHighlight(podiumEl, searchTerm);
            if (descriptionEl && descriptionEl.textContent.toLowerCase().includes(searchTerm)) applyHighlight(descriptionEl, searchTerm);
        }
    } else {
        card.style.display = 'none';
    }

    const favIcon = card.querySelector('.favorite-icon');
    if (favIcon) {
        favIcon.textContent = favorites.includes(rawName) ? 'favorite' : 'favorite_border';
    }
}

const cardsArray = Array.from(cardElements);

cardsArray.sort((a, b) => {
    if (sortMode === 'alpha') {
    return a.dataset.name.localeCompare(b.dataset.name);
    } else { // 'time'
    const timeA = parseInt(a.dataset.timestamp, 10);
    const timeB = parseInt(b.dataset.timestamp, 10);

    const aIsUnknown = timeA === 0;
    const bIsUnknown = timeB === 0;

    if (aIsUnknown && bIsUnknown) return a.dataset.name.localeCompare(b.dataset.name);
    if (aIsUnknown) return 1;
    if (bIsUnknown) return -1;
    if (timeA === timeB) return a.dataset.name.localeCompare(b.dataset.name);
    return timeA - timeB;
    }
});

cardsArray.forEach((card, index) => {
    card.style.order = index;
});

updateArtistCount(visibleCount);

if (!options.preserveScroll) {
    scrollToArtistListTop();
}
}

function updateArtistCount(n){
const pluralSuffix = n === 1 ? '' : 'en';
const entity = showingFavs ? `favoriet${pluralSuffix}` : `artiest${pluralSuffix}`;
countTextElement.textContent = `${n} ${entity} gevonden`;
}

function updateFilterButtonsUI(){
document.querySelectorAll('.filter-button').forEach(btn=>{
btn.classList.toggle('active', activePodia.includes(btn.dataset.podium));
});
}

function updateSortIconsUI(){
sortAlphaElement.classList.toggle('active', sortMode === 'alpha');
sortTimeElement.classList.toggle('active', sortMode === 'time');
}

function updateFavoriteToggleUI() {
favoriteToggleElement.textContent = showingFavs ? 'favorite' : 'favorite_border';
favoriteToggleElement.classList.toggle('active', showingFavs);
}

function updateActiveDayTabsUI() {
    document.querySelectorAll('.day-filter-button').forEach(btn => {
        const dayFilterForButton = btn.dataset.dayfilter;
        btn.classList.toggle('active', activeDays.includes(dayFilterForButton));
    });
}

function toggleFavoriteOnCard(name){
const idx = favorites.indexOf(name);
if(idx > -1) favorites.splice(idx,1);
else favorites.push(name);
setStoredJSON(PREFIX + 'favorites', favorites);
applyFiltersAndSort({ preserveScroll: true });
}

function clearLocalStorageData(){
if(!confirm('Weet je zeker dat je alle data (behalve favorieten en voorkeuren) wilt resetten? Dit kan nodig zijn na website updates.'))
return;

for(const key of Object.keys(localStorage)){
if(key.startsWith(PREFIX + 'artist_info_') || key === ALL_ARTISTS_DATA_CACHE_KEY || key === ALL_ARTISTS_DATA_TIMESTAMP_KEY){
localStorage.removeItem(key);
}
}
allArtistsData = [];
location.reload();
}

function updateBodyPadding() {
    if (controlBarGroup) {
        const headerHeight = controlBarGroup.offsetHeight;
        document.body.style.paddingTop = `${headerHeight + 10}px`;
    }
}

function handleScrollLogic() {
    if (!controlBarGroup) return;

    const currentScrollY = window.scrollY;
    const scrollDelta = currentScrollY - lastScrollY;
    const scrollThreshold = 5;

    if (currentScrollY < controlBarGroup.offsetHeight) {
        controlBarGroup.classList.remove('hidden');
    }
    else if (scrollDelta > scrollThreshold) {
        controlBarGroup.classList.add('hidden');
    }
    else if (scrollDelta < -scrollThreshold) {
        controlBarGroup.classList.remove('hidden');
    }

    lastScrollY = currentScrollY <= 0 ? 0 : currentScrollY;
    ticking = false;
}


function initializeEventListeners() {
dayFilterContainerElement.addEventListener('click', function(e) {
    const dayButton = e.target.closest('.day-filter-button');
    if (dayButton) {
        const dayFilter = dayButton.dataset.dayfilter;
        const index = activeDays.indexOf(dayFilter);
        if (index > -1) {
            activeDays.splice(index, 1);
        } else {
            activeDays.push(dayFilter);
        }
        setStoredJSON(PREFIX + 'activeDays', activeDays);
        updateActiveDayTabsUI();
        applyFiltersAndSort();
    }
});

filterContainerElement.addEventListener('click', function(e){
    const btn = e.target.closest('.filter-button');
    if(btn){
    const p = btn.dataset.podium;
    activePodia = activePodia.includes(p)
    ? activePodia.filter(x=>x!==p)
    : [...activePodia, p];
    setStoredJSON(PREFIX + 'activePodia', activePodia);
    updateFilterButtonsUI();
    applyFiltersAndSort();
    }
});

searchFieldElement.addEventListener('focus', function() {
    if (this.value.length > 0) {
        searchClickShouldClear = true;
    } else {
        searchClickShouldClear = false;
    }
});

searchFieldElement.addEventListener('click', function() {
    if (searchClickShouldClear && this.value.length > 0) {
        this.value = '';
        this.classList.remove('has-content');
        this.blur();
        applyFiltersAndSort();
        searchClickShouldClear = false; 
    }
});

searchFieldElement.addEventListener('input', function(){
    searchClickShouldClear = (this.value.length > 0);
    
    this.classList.toggle('has-content', this.value.length > 0);
    const v = this.value.toLowerCase();
    if(v === 'reset' || v === 'clear') {
        this.value = '';
        this.classList.remove('has-content');
        searchClickShouldClear = false;
        clearLocalStorageData();
    } else {
        applyFiltersAndSort();
    }
});

searchFieldElement.addEventListener('blur', function() {
    searchClickShouldClear = false;
});

searchFieldElement.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.keyCode === 13) {
        this.blur(); 
        e.preventDefault(); 
    }
});


sortAlphaElement.addEventListener('click', function(){
    sortMode = 'alpha';
    setStoredString('sortMode', sortMode);
    updateSortIconsUI();
    applyFiltersAndSort();
});
sortTimeElement.addEventListener('click', function(){
    sortMode = 'time';
    setStoredString('sortMode', sortMode);
    updateSortIconsUI();
    applyFiltersAndSort();
});

favoriteToggleElement.addEventListener('click', function(){
    showingFavs = !showingFavs;
    setStoredJSON(PREFIX + 'showingFavs', showingFavs);
    updateFavoriteToggleUI();
    applyFiltersAndSort();
});

artistListElement.addEventListener('click', e=>{
    const favIcon = e.target.closest('.favorite-icon');
    if(favIcon){
      toggleFavoriteOnCard(favIcon.dataset.name);
    }
    const spotifyButton = e.target.closest('.spotify-play-button');
    if (spotifyButton) {
        const spotifyId = spotifyButton.dataset.spotifyId;
        if (spotifyId) {
            dockedSpotifyPlayerContainer.innerHTML = ''; // Leeg de container
            const iframe = document.createElement('iframe');
            iframe.id = 'docked-spotify-iframe';
            iframe.allow = 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture';
            iframe.loading = 'lazy';
            iframe.src = `https://open.spotify.com/embed/artist/${spotifyId}?utm_source=generator&theme=0&autoplay=1`;
            dockedSpotifyPlayerContainer.appendChild(iframe);
            dockedSpotifyPlayerWrapper.classList.add('visible');
        }
    }
});

closeDockedPlayerButton.addEventListener('click', () => {
    dockedSpotifyPlayerWrapper.classList.remove('visible');
    setTimeout(() => {
        dockedSpotifyPlayerContainer.innerHTML = '';
    }, 300);
});


window.addEventListener('scroll', () => {
    if (!ticking) {
        window.requestAnimationFrame(handleScrollLogic);
        ticking = true;
    }
});

window.addEventListener('resize', updateBodyPadding);

if (document.fonts && iconsGroupElement) {
    document.fonts.ready.then(function() {
        iconsGroupElement.classList.add('loaded');
    }).catch(function(e) {
        console.warn('Fonts niet (op tijd) geladen, iconen toch getoond.', e);
        iconsGroupElement.classList.add('loaded');
    });
} else if (iconsGroupElement) {
    setTimeout(() => {
        iconsGroupElement.classList.add('loaded');
    }, 250);
}

}

async function main() {
initializeEventListeners();

updateFilterButtonsUI();
updateSortIconsUI(); 
updateFavoriteToggleUI();
updateActiveDayTabsUI();

await loadAllArtistsData();

if (allArtistsData.length > 0) {
    renderAllArtistCardsOnce();
    if (typeof setupImageLazyLoader === 'function') {
         setupImageLazyLoader();
    }
    applyFiltersAndSort();
} else {
    if (!errorMessageElement.style.display || errorMessageElement.style.display === 'none') {
    showError('Geen artiesten data gevonden of kunnen laden.');
    }
    updateArtistCount(0);
}
searchFieldElement.classList.toggle('has-content', searchFieldElement.value.length > 0);

updateBodyPadding();
handleScrollLogic();
}

main();

})();
</script>

</body>
</html>
