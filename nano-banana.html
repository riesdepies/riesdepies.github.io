<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nano-Banana</title>
<!-- AANGEPAST: Emoji favicon toegevoegd -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçå</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* CSS Variabelen (Design Systeem) - Light Mode (Default) */
:root {
--font-family-sans: 'Manrope', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
--bg-page: #f8f9fa;
--bg-container: #ffffff;
--color-text-primary: #1a1a1a;
--color-text-secondary: #6c757d;
--accent-primary: #FFD54F;
--accent-primary-dark: #FFCA28;
--bubble-bot-bg: #f1f3f4;
--bubble-user-bg: #FFF9C4;
--border-color: #e9ecef;
--radius-xl: 24px;
--radius-lg: 16px;
--radius-md: 12px;
--shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
--shadow-md: 0 8px 24px rgba(0,0,0,0.07);
}

/* Dark Mode Variabelen */
body.dark-mode {
--bg-page: #121212;
--bg-container: #1e1e1e;
--color-text-primary: #e0e0e0;
--color-text-secondary: #888888;
--bubble-bot-bg: #2a2a2a;
--bubble-user-bg: #3a3623;
--border-color: #333333;
--shadow-md: 0 8px 24px rgba(0,0,0,0.2);
}

/* Basis en Reset */
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; font-family: var(--font-family-sans); background-color: var(--bg-page); color: var(--color-text-primary); transition: background-color 0.3s, color 0.3s; }

/* Hoofd Layout Container */
#app-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 900px; margin: 0 auto; background-color: var(--bg-container); box-shadow: var(--shadow-md); border-radius: var(--radius-xl); max-height: 100%; transition: background-color 0.3s; }

/* Header */
header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; transition: border-color 0.3s; }
header h1 { font-size: 1.5em; font-weight: 700; display: flex; align-items: center; gap: 12px; cursor: pointer; user-select: none; -webkit-user-select: none; }
#settings-btn { background: none; border: none; cursor: pointer; color: var(--color-text-secondary); padding: 8px; display: flex; align-items: center; justify-content: center; }
#settings-btn svg { width: 28px; height: 28px; }

/* Chatberichten Gedeelte */
#chat-container { flex-grow: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 20px; }
.chat-message { display: flex; max-width: 100%; flex-shrink: 0; }
.message-bubble { padding: 14px 20px; border-radius: var(--radius-lg); line-height: 1.6; font-size: 16px; word-wrap: break-word; transition: background-color 0.3s, border 0.2s, box-shadow 0.2s; border: 2px solid transparent; max-width: 90%; }
.message-images { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
.message-images img { max-width: 150px; max-height: 150px; border-radius: var(--radius-md); object-fit: cover; }
.message-bubble p + .message-images { margin-top: 12px; }
.message-bubble .message-images:first-child { margin-top: 0; }
.message-bubble p:not(:last-child) { margin-bottom: 8px; }
.message-bubble img { max-width: 100%; border-radius: var(--radius-md); display: block; }
.message-bubble img.clickable-image { cursor: pointer; }

.user-message {
    width: 100%;
    display: flex;
    justify-content: flex-end;
}
.user-message .message-bubble { background-color: var(--bubble-user-bg); border-bottom-right-radius: 4px; }
.user-message[data-history-index] {
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
    -webkit-tap-highlight-color: transparent;
}

.bot-message { align-self: flex-start; }
.bot-message .message-bubble { background-color: var(--bubble-bot-bg); border-bottom-left-radius: 4px; }
.error-bubble { cursor: pointer; }
.copy-span { font-size: 0.9em; color: var(--color-text-secondary); opacity: 0.8; }
.loader-bubble { display: flex; align-items: center; justify-content: center; padding: 18px 20px; }
.loader-bubble span { animation-name: bounce; animation-duration: 1.4s; animation-iteration-count: infinite; animation-fill-mode: both; font-size: 24px; line-height: 1; }
.loader-bubble span:nth-child(2) { animation-delay: .2s; }
.loader-bubble span:nth-child(3) { animation-delay: .4s; }
@keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

/* Stijl voor bericht dat bewerkt wordt */
.chat-message.editing .message-bubble {
    border: 2px solid var(--accent-primary);
    box-shadow: 0 0 8px rgba(255, 213, 79, 0.5);
}

/* Input Gedeelte */
#input-area { flex-shrink: 0; padding: 12px 24px 24px 24px; border-top: 1px solid var(--border-color); background: var(--bg-container); transition: background-color 0.3s, border-color 0.3s; }
#image-preview-container { padding-bottom: 12px; display: none; position: relative; }
#image-preview-wrapper { display: flex; flex-wrap: wrap; gap: 10px; background: var(--bubble-bot-bg); padding: 10px; border-radius: var(--radius-md); transition: background-color 0.3s; }
.preview-image-wrapper { position: relative; display: inline-block; }
.preview-image-wrapper img { height: 60px; width: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; display: block; }
.remove-preview-btn { position: absolute; top: -8px; right: -8px; background: var(--color-text-secondary); color: white; border: 1px solid var(--bg-container); border-radius: 50%; width: 22px; height: 22px; font-size: 14px; line-height: 20px; text-align: center; cursor: pointer; font-weight: bold; padding: 0; box-shadow: var(--shadow-sm); }
#chat-form { display: flex; align-items: flex-end; gap: 12px; }
#message-input { flex-grow: 1; border: 1px solid var(--border-color); border-radius: var(--radius-lg); background-color: var(--bg-container); color: var(--color-text-primary); font-family: var(--font-family-sans); font-size: 16px; padding: 12px 16px; min-height: 104px; max-height: 250px; resize: none; transition: all 0.2s; }
#message-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(255, 213, 79, 0.4); }
#message-input::placeholder { color: var(--color-text-secondary); opacity: 0.8; }
.action-buttons { display: flex; flex-direction: column; gap: 8px; align-items: center; }
.action-buttons button, .action-buttons label { display: flex; align-items: center; justify-content: center; flex-shrink: 0; border-radius: 50%; border: none; cursor: pointer; transition: background-color: 0.2s; background-color: var(--accent-primary); color: #1a1a1a; }
.action-buttons button:hover, .action-buttons label:hover { background-color: var(--accent-primary-dark); }
#upload-label { width: 40px; height: 40px; }
#send-btn { width: 48px; height: 48px; }
#image-input { display: none; }

/* --- Modals --- */
#settings-modal, #fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
#fullscreen-modal { background-color: rgba(0, 0, 0, 0.85); z-index: 2000; }
#settings-content { background: var(--bg-container); padding: 30px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); width: 90%; max-width: 500px; transition: background-color 0.3s; }
#settings-content h2 { margin-top: 0; margin-bottom: 24px; }
#settings-content label { display: block; margin-bottom: 8px; font-weight: 500; }

/* Stijlen voor API-sleutel wrapper, input en toggle-knop */
.api-key-wrapper { position: relative; margin-bottom: 24px; }
#api-key-input { width: 100%; padding: 12px 55px 12px 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1em; background-color: var(--bg-container); color: var(--color-text-primary); transition: all 0.2s; }
#toggle-api-key-visibility { position: absolute; top: 50%; right: 8px; transform: translateY(-50%); background: transparent; border: none; border-left: 1px solid var(--border-color); padding: 6px 6px 6px 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-text-secondary); transition: color 0.2s, border-color 0.3s; }
#toggle-api-key-visibility svg { width: 22px; height: 22px; }
#toggle-api-key-visibility:hover { color: var(--color-text-primary); }

#api-key-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(255, 213, 79, 0.4); }
#settings-buttons { display: flex; justify-content: flex-end; gap: 10px; }
#settings-buttons button { padding: 10px 20px; border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 1em; font-weight: 600; }
#save-settings-btn { background-color: var(--accent-primary); color: #1a1a1a; }
#save-settings-btn:hover { background-color: var(--accent-primary-dark); }
#cancel-settings-btn { background-color: var(--bubble-bot-bg); color: var(--color-text-primary); transition: background-color 0.3s; }
#cancel-settings-btn:hover { background-color: #e2e6e9; }
body.dark-mode #cancel-settings-btn:hover { background-color: #3a3a3a; }
#fullscreen-image { max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: var(--radius-md); }
#close-fullscreen-btn { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; line-height: 40px; text-align: center; cursor: pointer; font-weight: bold; }

/* Stijlen voor de Dark Mode Toggle */
.setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--accent-primary); }
input:focus + .slider { box-shadow: 0 0 1px var(--accent-primary); }
input:checked + .slider:before { transform: translateX(22px); }

/* Model Selectie Stijl */
#model-select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background-color: var(--bg-container);
    color: var(--color-text-primary);
    font-size: 1em;
    font-family: var(--font-family-sans);
    margin-bottom: 24px;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
}
#model-select:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(255, 213, 79, 0.4);
}
body.dark-mode #model-select {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
}

/* --- Responsive Design --- */
@media (min-width: 901px) { html, body { height: auto; overflow: auto; } body { padding: 40px 20px; } #app-container { height: calc(100vh - 80px); max-height: 950px; border: 1px solid var(--border-color); } }
@media (max-width: 900px) { #app-container { border-radius: 0; } #input-area { padding: 12px; } header { padding: 16px; } #close-fullscreen-btn { top: 15px; right: 15px; } }
</style>
</head>
<body>

<div id="app-container">
<header>
<h1 id="page-title">üçå Nano-Banana</h1>
<button id="settings-btn" title="Settings">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg>
</button>
</header>
<main id="chat-container"></main>
<footer id="input-area">
<div id="image-preview-container"><div id="image-preview-wrapper"></div></div>
<form id="chat-form">
<textarea id="message-input" placeholder="Ask a question or give a command..." rows="1"></textarea>
<div class="action-buttons">
<input type="file" id="image-input" accept="image/*" multiple>
<label for="image-input" id="upload-label" title="Attach image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.122 2.122l7.81-7.81" /></svg></label>
<button type="submit" id="send-btn" title="Send"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" /></svg></button>
</div>
</form>
</footer>
</div>

<div id="settings-modal">
<div id="settings-content">
<h2 id="settings-title">Settings</h2>
<div class="setting-row">
<label for="dark-mode-toggle" id="dark-mode-label">Dark Mode</label>
<label class="toggle-switch">
<input type="checkbox" id="dark-mode-toggle">
<span class="slider"></span>
</label>
</div>

<!-- AANGEPAST: Model Selectie toegevoegd -->
<label for="model-select" id="model-label">AI Model</label>
<select id="model-select">
    <!-- Nano-Banana Pro: Gekoppeld aan Gemini 3 Pro (nieuwste) -->
    <option value="gemini-3-pro-image-preview">Nano-Banana Pro (Gemini 3 Pro)</option>
    <!-- Nano-Banana: Gekoppeld aan de legacy versie (zoals in originele code) -->
    <option value="gemini-2.5-flash-image-preview">Nano-Banana (Gemini 2.5 Flash)</option>
</select>

<label for="api-key-input" id="settings-label">Google AI API Key</label>
<div class="api-key-wrapper">
<input type="password" id="api-key-input" placeholder="Paste your API key here">
<button type="button" id="toggle-api-key-visibility"></button>
</div>
<div id="settings-buttons">
<button id="cancel-settings-btn">Cancel</button>
<button id="save-settings-btn">Save</button>
</div>
</div>
</div>

<div id="fullscreen-modal">
<button id="close-fullscreen-btn">&times;</button>
<img id="fullscreen-image" src="" alt="Fullscreen Image">
</div>

<script>
// --- TRANSLATIONS ---
const translations = {
en: { pageTitle: "Nano-Banana Interface", settingsTitle: "Settings", settingsBtnTitle: "Settings", darkModeLabel: "Dark Mode", modelLabel: "AI Model", settingsLabel: "Google AI API Key", apiKeyPlaceholder: "Paste your API key here", cancel: "Cancel", save: "Save", uploadLabelTitle: "Attach images", removeImgBtnTitle: "Remove image", sendBtnTitle: "Send", inputPlaceholder: "Ask a question or give a command...", copied: "(Copied!)", copyPrompt: "(Click to copy details)", clearChatConfirm: "Are you sure you want to clear the entire chat history? This action cannot be undone.", welcome_base: "Welcome to Nano-Banana, an AI image generator/editor/analyzer chatbot, powered by Google.", welcome_nokey: "Please enter your Google AI API key in Settings.", apiKeySaved: "Settings saved!", apiKeyNeeded: "Please set your API key in the settings menu (top right icon) first.", invalidApiKey: "Please enter a valid API key.", imgProcessError: "Sorry, I could not process your image(s).", genericError: "Oops! An error occurred.", emptyResponse: "I'm sorry, I couldn't generate a response.", emptyResponseFiltered: "The response was empty. This can happen if the request violates content policies. Please try rephrasing your prompt.", blockedResponse: "I cannot process this request. Reason:", finishReasonSafety: "The response was blocked because the content was considered unsafe. Please adjust your prompt.", finishReasonRecitation: "The response was blocked to avoid recitation of potentially copyrighted content. Please try rephrasing your request.", finishReasonOther: "The response could not be completed for an unspecified reason. Please try again.", finishReasonProhibited: "The response was blocked because it contained prohibited content.", imageBlocked: "\n\n*(Note: An image was generated but could not be displayed due to content restrictions.)*", showApiKeyTitle: "Show API Key", hideApiKeyTitle: "Hide API Key" },
nl: { pageTitle: "Nano-Banana Interface", settingsTitle: "Instellingen", settingsBtnTitle: "Instellingen", darkModeLabel: "Donkere Modus", modelLabel: "AI Model", settingsLabel: "Google AI API Sleutel", apiKeyPlaceholder: "Plak hier je API sleutel", cancel: "Annuleren", save: "Opslaan", uploadLabelTitle: "Afbeeldingen bijvoegen", removeImgBtnTitle: "Verwijder afbeelding", sendBtnTitle: "Verzend", inputPlaceholder: "Stel een vraag of geef een commando...", copied: "(Gekopieerd!)", copyPrompt: "(Klik om details te kopi√´ren)", clearChatConfirm: "Weet je zeker dat je de hele chatgeschiedenis wilt wissen? Deze actie kan niet ongedaan worden gemaakt.", welcome_base: "Welkom bij Nano-Banana, een AI-beeldgenerator, -editor en -analysator chatbot van Google.", welcome_nokey: "Voer je Google AI API-sleutel in bij Instellingen.", apiKeySaved: "Instellingen opgeslagen!", apiKeyNeeded: "Stel alsjeblieft eerst je API sleutel in via het instellingenmenu (icoon rechtsboven).", invalidApiKey: "Voer een geldige API sleutel in.", imgProcessError: "Sorry, ik kon je afbeelding(en) niet verwerken.", genericError: "Oeps! Er is een fout opgetreden.", emptyResponse: "Sorry, ik kon geen antwoord genereren.", emptyResponseFiltered: "Het antwoord was leeg. Dit kan gebeuren als het verzoek de inhoudsregels schendt. Probeer je vraag anders te formuleren.", blockedResponse: "Ik kan dit verzoek niet verwerken. Reden:", finishReasonSafety: "Het antwoord is geblokkeerd omdat de inhoud als onveilig werd beschouwd. Pas je vraag aan.", finishReasonRecitation: "Het antwoord is geblokkeerd om herhaling van mogelijk auteursrechtelijk beschermde inhoud te voorkomen. Probeer je verzoek anders te formuleren.", finishReasonOther: "Het antwoord kon om een onbekende reden niet worden voltooid. Probeer het opnieuw.", finishReasonProhibited: "Het antwoord is geblokkeerd omdat het verboden inhoud bevatte.", imageBlocked: "\n\n*(Let op: er is een afbeelding gegenereerd, maar deze kon niet worden weergegeven vanwege inhoudsbeperkingen.)*", showApiKeyTitle: "Toon API Sleutel", hideApiKeyTitle: "Verberg API Sleutel" }
};
let T;

// --- STATE & CONSTANTS ---
// AANGEPAST: De URL wordt nu dynamisch gebouwd, dus API_URL is een base string geworden
const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';
// AANGEPAST: Default model is Nano-Banana Pro (Gemini 3 Pro)
const DEFAULT_MODEL = 'gemini-3-pro-image-preview';
let currentModel = DEFAULT_MODEL;

const chatHistory = [];
let apiKey = '';
let currentFiles = [];
// State voor bewerkingsmodus
let editingMessageIndex = null;
let preEditState = { text: '', files: [] };


// --- DOM HELPER ---
const getElements = (ids) => ids.reduce((acc, id) => {
const camelCaseId = id.replace(/-./g, m => m[1].toUpperCase());
acc[camelCaseId] = document.getElementById(id);
return acc;
}, {});

const D = getElements([
'page-title', 'settings-btn', 'settings-modal', 'save-settings-btn', 'cancel-settings-btn',
'api-key-input', 'chat-form', 'message-input', 'chat-container', 'image-input',
'image-preview-container', 'image-preview-wrapper', 'fullscreen-modal', 'fullscreen-image',
'close-fullscreen-btn', 'dark-mode-toggle', 'toggle-api-key-visibility', 'input-area', 'model-select'
]);

// --- CORE FUNCTIONS ---

function setLanguage() {
const lang = navigator.language.split('-')[0];
document.documentElement.lang = lang;
T = (lang === 'nl') ? translations.nl : translations.en;

document.title = T.pageTitle;
D.settingsBtn.title = T.settingsBtnTitle;
document.getElementById('settings-title').textContent = T.settingsTitle;
document.getElementById('dark-mode-label').textContent = T.darkModeLabel;
document.getElementById('model-label').textContent = T.modelLabel;
document.getElementById('settings-label').textContent = T.settingsLabel;
D.apiKeyInput.placeholder = T.apiKeyPlaceholder;
D.cancelSettingsBtn.textContent = T.cancel;
D.saveSettingsBtn.textContent = T.save;
document.getElementById('upload-label').title = T.uploadLabelTitle;
document.getElementById('send-btn').title = T.sendBtnTitle;
D.messageInput.placeholder = T.inputPlaceholder;

let welcomeMessage = T.welcome_base;
if (!localStorage.getItem('nanoBananaApiKey')) {
welcomeMessage += ` ${T.welcome_nokey}`;
}
appendMessage('bot', { text: welcomeMessage });
}

async function handleUserMessage() {
const userMessageText = D.messageInput.value.trim();
if (!userMessageText && currentFiles.length === 0) return;
if (!apiKey) return appendMessage('bot', { text: T.apiKeyNeeded });

if (editingMessageIndex !== null) {
    const messageToEdit = D.chatContainer.querySelector(`.chat-message[data-history-index="${editingMessageIndex}"]`);
    if (messageToEdit) {
        let sibling = messageToEdit.nextElementSibling;
        while (sibling) {
            let tempSibling = sibling.nextElementSibling;
            sibling.remove();
            sibling = tempSibling;
        }
        messageToEdit.remove();
    }
    chatHistory.length = editingMessageIndex;
}

const userParts = [];
const imagesForDisplay = [];
const filesToSend = currentFiles.map(item => item.file);

if (filesToSend.length > 0) {
try {
const conversionPromises = filesToSend.map(file => {
imagesForDisplay.push(URL.createObjectURL(file));
return fileToBase64(file);
});
const imageBase64Array = await Promise.all(conversionPromises);
imageBase64Array.forEach(imgData => userParts.push({ inlineData: { mimeType: imgData.mimeType, data: imgData.data } }));
} catch (error) {
console.error("Error converting images:", error);
return appendMessage('bot', { text: T.imgProcessError });
}
}

if (userMessageText) userParts.push({ text: userMessageText });

appendMessage('user', { text: userMessageText, images: imagesForDisplay }, chatHistory.length);
chatHistory.push({ role: "user", parts: userParts, originalFiles: [...currentFiles] });

if (editingMessageIndex !== null) {
    cancelEditing(true);
}

D.messageInput.value = '';
clearAllPreviews();
autoResizeTextarea();

callNanoBananaAPI();
}

async function callNanoBananaAPI() {
const loaderElement = showLoader();
try {
const apiHistory = chatHistory.map(({ role, parts }) => ({ role, parts }));

// AANGEPAST: Dynamische URL op basis van gekozen model
const apiUrl = `${API_BASE_URL}${currentModel}:generateContent?key=${apiKey}`;

const response = await fetch(apiUrl, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ contents: apiHistory }),
});
const data = await response.json();

if (!response.ok) {
return updateLoader(loaderElement, data?.error?.message || T.genericError, null, data);
}

const candidate = data.candidates?.[0];
if (candidate) {
const { finishReason, content, safetyRatings } = candidate;
if (finishReason && finishReason !== 'STOP' && finishReason !== 'MAX_TOKENS') {
const reasonMap = { 'SAFETY': T.finishReasonSafety, 'RECITATION': T.finishReasonRecitation, 'PROHIBITED_CONTENT': T.finishReasonProhibited };
return updateLoader(loaderElement, reasonMap[finishReason] || T.finishReasonOther, null, data);
}

if (content?.parts) {
chatHistory.push(content);
const responseParts = { text: '', image: null };
content.parts.forEach(part => {
if (part.text) responseParts.text += part.text + '\n';
else if (part.inlineData) responseParts.image = { data: part.inlineData.data, mimeType: part.inlineData.mimeType };
});

const trimmedText = responseParts.text.trim();

if ((!trimmedText || trimmedText === '```') && !responseParts.image) {
return updateLoader(loaderElement, T.emptyResponseFiltered, null, data);
}

const wasBlockedBySafety = safetyRatings?.some(r => r.probability !== 'NEGLIGIBLE');
if (trimmedText && !responseParts.image && wasBlockedBySafety) {
responseParts.text += T.imageBlocked;
}

updateLoader(loaderElement, responseParts.text.trim(), responseParts.image, null, chatHistory.length - 1);
} else {
updateLoader(loaderElement, T.emptyResponseFiltered, null, data);
}
} else if (data.promptFeedback) {
updateLoader(loaderElement, `${T.blockedResponse} ${data.promptFeedback.blockReason}`, null, data);
} else {
updateLoader(loaderElement, T.emptyResponse, null, data);
}
} catch (error) {
console.error('Error calling API:', error);
updateLoader(loaderElement, T.genericError, null, { error: error.toString() });
}
}

// --- UI & MESSAGE FUNCTIONS ---

function createBubbleContent({ text = '', images = [], image, errorDetails = null }) {
let imageHtml = '';
const imageUrls = Array.isArray(images) ? images : [];
if (image?.data) imageUrls.push(`data:${image.mimeType};base64,${image.data}`);

if (imageUrls.length > 0) {
imageHtml += '<div class="message-images">';
imageUrls.forEach(src => {
imageHtml += `<img src="${src}" alt="Image" class="clickable-image">`;
});
imageHtml += '</div>';
}

const formattedText = text
.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
.replace(/\*(.*?)\*/g, '<em>$1</em>')
.replace(/\n/g, '<br>');

const errorHtml = errorDetails ? ` <span class="copy-span">${T.copyPrompt}</span>` : '';
const textHtml = text ? `<p>${formattedText}${errorHtml}</p>` : '';

return `${textHtml}${imageHtml}`;
}

function appendMessage(type, content, historyIndex = null) {
const messageElement = document.createElement('div');
messageElement.className = `chat-message ${type}-message`;
if (historyIndex !== null) {
messageElement.dataset.historyIndex = historyIndex;
}
messageElement.innerHTML = `<div class="message-bubble">${createBubbleContent(content)}</div>`;
D.chatContainer.appendChild(messageElement);
scrollToBottom();
}

function showLoader() {
const loaderElement = document.createElement('div');
loaderElement.className = 'chat-message bot-message';
loaderElement.innerHTML = `<div class="message-bubble loader-bubble"><span>.</span><span>.</span><span>.</span></div>`;
D.chatContainer.appendChild(loaderElement);
scrollToBottom();
return loaderElement;
}

function updateLoader(loaderElement, text, imageObject, errorDetails, historyIndex = null) {
const bubble = loaderElement.querySelector('.message-bubble');
if (!bubble) return;
if (historyIndex !== null) {
loaderElement.dataset.historyIndex = historyIndex;
}
bubble.classList.remove('loader-bubble');
bubble.innerHTML = createBubbleContent({ text, image: imageObject, errorDetails });
if (errorDetails) {
bubble.classList.add('error-bubble');
bubble.dataset.errorDetails = JSON.stringify(errorDetails, null, 2);
}
}

function createPreviewElement(id, file) {
const wrapper = document.createElement('div');
wrapper.className = 'preview-image-wrapper';
wrapper.dataset.id = id;

const img = document.createElement('img');
img.title = file.name;
img.onclick = () => openFullscreen(img.src);

const removeBtn = document.createElement('button');
removeBtn.className = 'remove-preview-btn';
removeBtn.innerHTML = '&times;';
removeBtn.title = T.removeImgBtnTitle;
removeBtn.onclick = (e) => { e.stopPropagation(); removeImageById(id); };

const reader = new FileReader();
reader.onload = e => img.src = e.target.result;
reader.readAsDataURL(file);

wrapper.append(img, removeBtn);
D.imagePreviewWrapper.appendChild(wrapper);
}

function removeImageById(id) {
currentFiles = currentFiles.filter(item => item.id !== id);
D.imagePreviewWrapper.querySelector(`.preview-image-wrapper[data-id="${id}"]`)?.remove();
if (currentFiles.length === 0) D.imagePreviewContainer.style.display = 'none';
}

function clearAllPreviews() {
currentFiles = [];
D.imageInput.value = '';
D.imagePreviewWrapper.innerHTML = '';
D.imagePreviewContainer.style.display = 'none';
}

function openFullscreen(src) {
D.fullscreenImage.src = src;
D.fullscreenModal.style.display = 'flex';
history.pushState({ modal: 'fullscreen' }, '', '#fullscreen');
}

function closeFullscreen() {
if (D.fullscreenModal.style.display === 'none') return;
D.fullscreenModal.style.display = 'none';
if (location.hash === '#fullscreen') {
history.back();
}
}

function setTheme(theme) {
localStorage.setItem('nanoBananaTheme', theme);
document.body.className = theme === 'dark' ? 'dark-mode' : '';
D.darkModeToggle.checked = theme === 'dark';
}

// --- Functies voor bewerkingsmodus ---

function startEditing(messageIndex) {
if (editingMessageIndex === messageIndex) return;
cancelEditing();

const messageData = chatHistory[messageIndex];
if (!messageData || messageData.role !== 'user') return;

const messageElement = document.querySelector(`.chat-message[data-history-index="${messageIndex}"]`);
if (messageElement) messageElement.classList.add('editing');

preEditState = { text: D.messageInput.value, files: [...currentFiles] };
editingMessageIndex = messageIndex;

const textPart = messageData.parts.find(p => p.text);
D.messageInput.value = textPart ? textPart.text : '';

clearAllPreviews();
if (messageData.originalFiles && messageData.originalFiles.length > 0) {
currentFiles = [...messageData.originalFiles];
currentFiles.forEach(item => createPreviewElement(item.id, item.file));
D.imagePreviewContainer.style.display = 'block';
}

autoResizeTextarea();
D.messageInput.focus();
}

function cancelEditing(isSilent = false) {
if (editingMessageIndex === null) return;

document.querySelectorAll('.chat-message.editing').forEach(el => el.classList.remove('editing'));

if (!isSilent) {
    D.messageInput.value = preEditState.text;
    clearAllPreviews();
    if (preEditState.files && preEditState.files.length > 0) {
        currentFiles = [...preEditState.files];
        currentFiles.forEach(item => createPreviewElement(item.id, item.file));
        D.imagePreviewContainer.style.display = 'block';
    }
}

editingMessageIndex = null;
preEditState = { text: '', files: [] };
if (!isSilent) autoResizeTextarea();
}

const autoResizeTextarea = () => { D.messageInput.style.height = 'auto'; D.messageInput.style.height = D.messageInput.scrollHeight + 'px'; };
const scrollToBottom = () => { D.chatContainer.scrollTop = D.chatContainer.scrollHeight; };
const fileToBase64 = (file) => new Promise((resolve, reject) => {
const reader = new FileReader();
reader.readAsDataURL(file);
reader.onload = () => resolve({ mimeType: file.type, data: reader.result.toString().replace(/^data:(.*,)?/, '') });
reader.onerror = error => reject(error);
});

// --- EVENT LISTENERS ---

function setupEventListeners() {
D.pageTitle.addEventListener('click', () => {
if (confirm(T.clearChatConfirm)) {
cancelEditing();
D.chatContainer.innerHTML = '';
chatHistory.length = 0;
let welcomeMessage = T.welcome_base;
if (!apiKey) welcomeMessage += ` ${T.welcome_nokey}`;
appendMessage('bot', { text: welcomeMessage });
}
});

// Settings Modal Openen
D.settingsBtn.addEventListener('click', () => {
    D.apiKeyInput.value = apiKey;
    // Zet de selectbox op het huidige model (of default als nog niet geladen in UI)
    D.modelSelect.value = currentModel;
    D.settingsModal.style.display = 'flex';
});

D.cancelSettingsBtn.addEventListener('click', () => D.settingsModal.style.display = 'none');

D.settingsModal.addEventListener('click', (e) => {
if (e.target === D.settingsModal) {
D.settingsModal.style.display = 'none';
}
});

// AANGEPAST: Instellingen opslaan (Key + Model)
D.saveSettingsBtn.addEventListener('click', () => {
const newApiKey = D.apiKeyInput.value.trim();
const selectedModel = D.modelSelect.value; // Haal geselecteerd model op

if (newApiKey) {
localStorage.setItem('nanoBananaApiKey', newApiKey);
localStorage.setItem('nanoBananaModel', selectedModel); // Sla model op

apiKey = newApiKey;
currentModel = selectedModel; // Update actieve model variabele

D.settingsModal.style.display = 'none';
appendMessage('bot', { text: T.apiKeySaved });
} else {
alert(T.invalidApiKey);
}
});

const eyeIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.432 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>`;
const eyeSlashIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.243 4.243L6.228 6.228" /></svg>`;

D.toggleApiKeyVisibility.innerHTML = eyeIconSVG;
D.toggleApiKeyVisibility.title = T.showApiKeyTitle;

D.toggleApiKeyVisibility.addEventListener('click', () => {
const isPassword = D.apiKeyInput.type === 'password';
D.apiKeyInput.type = isPassword ? 'text' : 'password';
D.toggleApiKeyVisibility.innerHTML = isPassword ? eyeSlashIconSVG : eyeIconSVG;
D.toggleApiKeyVisibility.title = isPassword ? T.hideApiKeyTitle : T.showApiKeyTitle;
});

D.darkModeToggle.addEventListener('change', () => {
setTheme(D.darkModeToggle.checked ? 'dark' : 'light');
});

D.chatForm.addEventListener('submit', e => { e.preventDefault(); handleUserMessage(); });
D.messageInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleUserMessage(); } });
D.messageInput.addEventListener('input', autoResizeTextarea);

D.imageInput.addEventListener('change', e => {
const files = Array.from(e.target.files);
if (files.length > 0) {
files.forEach(file => {
const id = Date.now() + '-' + file.name;
currentFiles.push({ id, file });
createPreviewElement(id, file);
});
D.imagePreviewContainer.style.display = 'block';
}
D.imageInput.value = '';
});

D.chatContainer.addEventListener('click', e => {
const target = e.target;
if (target.classList.contains('clickable-image')) {
    openFullscreen(target.src);
    return;
}
if (target.closest('.error-bubble')) return;

const messageEl = e.target.closest('.user-message[data-history-index]');
if (messageEl) {
    if (editingMessageIndex === null) {
        const messageIndex = parseInt(messageEl.dataset.historyIndex, 10);
        if (!isNaN(messageIndex)) {
            startEditing(messageIndex);
            e.stopPropagation();
        }
    }
}
});

document.body.addEventListener('click', e => {
if (editingMessageIndex === null) return;
if (!D.inputArea.contains(e.target)) {
    cancelEditing();
}
});

D.closeFullscreenBtn.addEventListener('click', closeFullscreen);
D.fullscreenModal.addEventListener('click', e => { if (e.target === D.fullscreenModal) closeFullscreen(); });
window.addEventListener('popstate', () => {
if (D.fullscreenModal.style.display === 'flex') {
closeFullscreen();
}
});
}

document.addEventListener('DOMContentLoaded', () => {
apiKey = localStorage.getItem('nanoBananaApiKey') || '';
// AANGEPAST: Model laden uit storage, of default (Pro) gebruiken
currentModel = localStorage.getItem('nanoBananaModel') || DEFAULT_MODEL;

if (apiKey) D.apiKeyInput.value = apiKey;

const savedTheme = localStorage.getItem('nanoBananaTheme') || 'light';
setTheme(savedTheme);

setLanguage();
setupEventListeners();
});

</script>
</body>
</html>