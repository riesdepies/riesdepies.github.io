<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nano-Banana Interface</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* CSS Variabelen (Design Systeem) */
:root {
--font-family-sans: 'Manrope', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
--bg-page: #f8f9fa;
--bg-container: #ffffff;
--color-text-primary: #1a1a1a;
--color-text-secondary: #6c757d;
--accent-primary: #FFD54F;
--accent-primary-dark: #FFCA28;
--bubble-bot-bg: #f1f3f4;
--bubble-user-bg: #FFF9C4;
--border-color: #e9ecef;
--radius-xl: 24px;
--radius-lg: 16px;
--radius-md: 12px;
--shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
--shadow-md: 0 8px 24px rgba(0,0,0,0.07);
}

/* Basis en Reset */
* {
box-sizing: border-box;
margin: 0;
padding: 0;
}

html, body {
height: 100%;
overflow: hidden;
font-family: var(--font-family-sans);
background-color: var(--bg-page);
color: var(--color-text-primary);
}

/* Hoofd Layout Container */
#app-container {
display: flex;
flex-direction: column;
height: 100%;
width: 100%;
max-width: 900px;
margin: 0 auto;
background-color: var(--bg-container);
box-shadow: var(--shadow-md);
border-radius: var(--radius-xl);
max-height: 100%;
}

/* Header */
header {
padding: 16px 24px;
border-bottom: 1px solid var(--border-color);
display: flex;
justify-content: space-between;
align-items: center;
flex-shrink: 0;
}

header h1 {
font-size: 1.5em;
font-weight: 700;
display: flex;
align-items: center;
gap: 12px;
cursor: pointer;
user-select: none;
-webkit-user-select: none; /* Voor Safari */
}

#settings-btn {
background: none;
border: none;
cursor: pointer;
color: var(--color-text-secondary);
padding: 8px;
display: flex;
align-items: center;
justify-content: center;
}
#settings-btn svg {
width: 28px;
height: 28px;
}

/* Chatberichten Gedeelte */
#chat-container {
flex-grow: 1;
overflow-y: auto;
padding: 24px;
display: flex;
flex-direction: column;
gap: 20px;
}

.chat-message {
display: flex;
max-width: 80%;
flex-shrink: 0;
}

.message-bubble {
padding: 14px 20px;
border-radius: var(--radius-lg);
line-height: 1.6;
font-size: 16px;
word-wrap: break-word;
transition: background-color 0.3s;
}

.message-images {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
}
.message-images img {
    max-width: 150px;
    max-height: 150px;
    border-radius: var(--radius-md);
    object-fit: cover;
}
.message-bubble p + .message-images {
    margin-top: 12px;
}
.message-bubble .message-images:first-child {
    margin-top: 0;
}


.message-bubble p:not(:last-child) {
margin-bottom: 8px;
}

.message-bubble img {
max-width: 100%;
border-radius: var(--radius-md);
display: block;
}

.message-bubble img.clickable-image {
cursor: pointer;
}

.user-message {
align-self: flex-end;
margin-left: auto;
}
.user-message .message-bubble {
background-color: var(--bubble-user-bg);
border-bottom-right-radius: 4px;
}

.bot-message {
align-self: flex-start;
}
.bot-message .message-bubble {
background-color: var(--bubble-bot-bg);
border-bottom-left-radius: 4px;
}

.error-bubble {
cursor: pointer;
}
.copy-span {
    font-size: 0.9em;
    color: var(--color-text-secondary);
    opacity: 0.8;
}

.loader-bubble {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 18px 20px;
}
.loader-bubble span {
    animation-name: bounce;
    animation-duration: 1.4s;
    animation-iteration-count: infinite;
    animation-fill-mode: both;
    font-size: 24px;
    line-height: 1;
}
.loader-bubble span:nth-child(2) { animation-delay: .2s; }
.loader-bubble span:nth-child(3) { animation-delay: .4s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1.0); }
}

/* Input Gedeelte */
#input-area {
flex-shrink: 0;
padding: 12px 24px 24px 24px;
border-top: 1px solid var(--border-color);
background: var(--bg-container);
}

#image-preview-container {
padding-bottom: 12px;
display: none;
position: relative;
}
#image-preview-wrapper {
display: flex;
flex-wrap: wrap;
gap: 10px;
background: var(--bubble-bot-bg);
padding: 10px;
border-radius: var(--radius-md);
}

/* AANGEPAST: Stijlen voor individuele preview */
.preview-image-wrapper {
    position: relative;
    display: inline-block;
}
.preview-image-wrapper img {
    height: 60px;
    width: 60px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    display: block;
}
.remove-preview-btn {
    position: absolute;
    top: -8px; right: -8px;
    background: var(--color-text-secondary);
    color: white; border: 1px solid var(--bg-container); border-radius: 50%;
    width: 22px; height: 22px;
    font-size: 14px; line-height: 20px;
    text-align: center; cursor: pointer; font-weight: bold;
    padding: 0;
    box-shadow: var(--shadow-sm);
}


#chat-form {
display: flex;
align-items: flex-end;
gap: 12px;
}

#message-input {
flex-grow: 1;
border: 1px solid var(--border-color);
border-radius: var(--radius-lg);
background-color: #ffffff;
font-family: var(--font-family-sans);
font-size: 16px;
padding: 12px 16px;
min-height: 104px;
max-height: 250px;
resize: none;
transition: border-color 0.2s, box-shadow 0.2s;
}
#message-input:focus {
outline: none;
border-color: var(--accent-primary);
box-shadow: 0 0 0 3px rgba(255, 213, 79, 0.4);
}
#message-input::placeholder {
color: var(--color-text-secondary);
opacity: 0.8;
}

.action-buttons {
display: flex;
flex-direction: column;
gap: 8px;
align-items: center;
}

.action-buttons button, .action-buttons label {
display: flex; align-items: center; justify-content: center;
flex-shrink: 0;
border-radius: 50%; border: none; cursor: pointer;
transition: background-color 0.2s;
background-color: var(--accent-primary);
color: var(--color-text-primary);
}

.action-buttons button:hover, .action-buttons label:hover {
background-color: var(--accent-primary-dark);
}

#upload-label {
width: 40px;
height: 40px;
}
#send-btn {
width: 48px;
height: 48px;
}

#image-input { display: none; }

/* --- SETTINGS MODAL --- */
#settings-modal {
position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background: rgba(0, 0, 0, 0.5); display: none;
justify-content: center; align-items: center; z-index: 1000;
backdrop-filter: blur(5px);
}
#settings-content {
background: var(--bg-container); padding: 30px;
border-radius: var(--radius-lg); box-shadow: var(--shadow-md);
width: 90%; max-width: 500px;
}
#settings-content h2 {
margin-top: 0;
margin-bottom: 24px;
color: var(--color-text-primary);
font-family: var(--font-family-sans);
}
#settings-content label {
display: block;
margin-bottom: 8px;
font-weight: 500;
font-family: var(--font-family-sans);
}
#api-key-input {
width: 100%; padding: 12px;
border: 1px solid var(--border-color); border-radius: var(--radius-md);
font-size: 1em; margin-bottom: 24px; font-family: var(--font-family-sans);
transition: border-color 0.2s, box-shadow 0.2s;
}
#api-key-input:focus {
outline: none;
border-color: var(--accent-primary);
box-shadow: 0 0 0 3px rgba(255, 213, 79, 0.4);
}
#settings-buttons { display: flex; justify-content: flex-end; gap: 10px; }
#settings-buttons button {
padding: 10px 20px; border: none; border-radius: var(--radius-md);
cursor: pointer; font-size: 1em; font-weight: 600; font-family: var(--font-family-sans);
transition: background-color 0.2s;
}
#save-settings-btn {
background-color: var(--accent-primary);
color: var(--color-text-primary);
}
#save-settings-btn:hover { background-color: var(--accent-primary-dark); }
#cancel-settings-btn {
background-color: var(--bubble-bot-bg);
color: var(--color-text-primary);
}
#cancel-settings-btn:hover { background-color: #e2e6e9; }


/* --- Fullscreen Image Modal --- */
#fullscreen-modal {
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
background-color: rgba(0, 0, 0, 0.85);
backdrop-filter: blur(8px);
display: none;
justify-content: center;
align-items: center;
z-index: 2000;
}
#fullscreen-image {
max-width: 90vw;
max-height: 90vh;
object-fit: contain;
border-radius: var(--radius-md);
}
#close-fullscreen-btn {
position: absolute;
top: 20px;
right: 20px;
background: rgba(0,0,0,0.5);
color: white;
border: none;
border-radius: 50%;
width: 40px; height: 40px;
font-size: 24px;
line-height: 40px;
text-align: center;
cursor: pointer;
font-weight: bold;
}


/* --- Responsive Design --- */
@media (min-width: 901px) {
    html, body {
        height: auto;
        overflow: auto;
    }
    body {
        padding: 40px 20px;
    }
    #app-container {
        height: calc(100vh - 80px);
        max-height: 950px;
        border: 1px solid var(--border-color);
    }
}

@media (max-width: 900px) {
#app-container { border-radius: 0; }
#input-area { padding: 12px; }
header { padding: 16px; }
#close-fullscreen-btn { top: 15px; right: 15px; }
}
</style>
</head>
<body>

<div id="app-container">
<header>
<h1 id="page-title">üçå Nano-Banana</h1>
<button id="settings-btn" title="Settings">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
<path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
</svg>
</button>
</header>

<main id="chat-container">
<!-- Messages will be added here by JavaScript -->
</main>

<footer id="input-area">
<div id="image-preview-container">
    <div id="image-preview-wrapper">
        <!-- Image previews will be added here by JavaScript -->
    </div>
</div>
<form id="chat-form">
<textarea id="message-input" placeholder="Ask a question or give a command..." rows="1"></textarea>
<div class="action-buttons">
<input type="file" id="image-input" accept="image/*" multiple>
<label for="image-input" id="upload-label" title="Attach image">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
<path stroke-linecap="round" stroke-linejoin="round" d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.122 2.122l7.81-7.81" />
</svg>
</label>
<button type="submit" id="send-btn" title="Send">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
<path d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" />
</svg>
</button>
</div>
</form>
</footer>
</div>

<div id="settings-modal">
<div id="settings-content">
<h2 id="settings-title">Settings</h2>
<label for="api-key-input" id="settings-label">Google AI API Key</label>
<input type="password" id="api-key-input" placeholder="Paste your API key here">
<div id="settings-buttons">
<button id="cancel-settings-btn">Cancel</button>
<button id="save-settings-btn">Save</button>
</div>
</div>
</div>

<div id="fullscreen-modal">
  <button id="close-fullscreen-btn">&times;</button>
  <img id="fullscreen-image" src="" alt="Fullscreen Image">
</div>

<script>
// --- TRANSLATIONS (AANGEPAST) ---
const translations = {
en: {
// UI Elements
pageTitle: "Nano-Banana Interface",
settingsTitle: "Settings",
settingsBtnTitle: "Settings",
settingsLabel: "Google AI API Key",
apiKeyPlaceholder: "Paste your API key here",
cancel: "Cancel",
save: "Save",
uploadLabelTitle: "Attach images",
removeImgBtnTitle: "Remove image", // Changed from "all images"
sendBtnTitle: "Send",
inputPlaceholder: "Ask a question or give a command...",
copied: "(Copied!)",
copyPrompt: "(Click to copy details)",
clearChatConfirm: "Are you sure you want to clear the entire chat history? This action cannot be undone.",
welcome_base: "Welcome to Nano-Banana, an AI image generator/editor chatbot by Google.",
welcome_nokey: "Please enter your Google AI API key in Settings.",
apiKeySaved: "API key saved!",
apiKeyNeeded: "Please set your API key in the settings menu (top right icon) first.",
invalidApiKey: "Please enter a valid API key.",
imgProcessError: "Sorry, I could not process your image(s).",
// Error messages
genericError: "Oops! An error occurred.",
emptyResponse: "I'm sorry, I couldn't generate a response.",
blockedResponse: "I cannot process this request. Reason:",
finishReasonSafety: "The response was blocked because the content was considered unsafe. Please adjust your prompt.",
finishReasonRecitation: "The response was blocked to avoid recitation of potentially copyrighted content. Please try rephrasing your request.",
finishReasonOther: "The response could not be completed for an unspecified reason. Please try again.",
finishReasonProhibited: "The response was blocked because it contained prohibited content.",
imageBlocked: "\n\n*(Note: An image was generated but could not be displayed due to content restrictions.)*"
},
nl: {
// UI Elements
pageTitle: "Nano-Banana Interface",
settingsTitle: "Instellingen",
settingsBtnTitle: "Instellingen",
settingsLabel: "Google AI API Sleutel",
apiKeyPlaceholder: "Plak hier je API sleutel",
cancel: "Annuleren",
save: "Opslaan",
uploadLabelTitle: "Afbeeldingen bijvoegen",
removeImgBtnTitle: "Verwijder afbeelding", // Aangepast
sendBtnTitle: "Verzend",
inputPlaceholder: "Stel een vraag of geef een commando...",
copied: "(Gekopieerd!)",
copyPrompt: "(Klik om details te kopi√´ren)",
clearChatConfirm: "Weet je zeker dat je de hele chatgeschiedenis wilt wissen? Deze actie kan niet ongedaan worden gemaakt.",
welcome_base: "Welkom bij Nano-Banana, een AI-beeldgenerator/editor chatbot van Google.",
welcome_nokey: "Voer je Google AI API-sleutel in bij Instellingen.",
apiKeySaved: "API sleutel opgeslagen!",
apiKeyNeeded: "Stel alsjeblieft eerst je API sleutel in via het instellingenmenu (icoon rechtsboven).",
invalidApiKey: "Voer een geldige API sleutel in.",
imgProcessError: "Sorry, ik kon je afbeelding(en) niet verwerken.",
// Error messages
genericError: "Oeps! Er is een fout opgetreden.",
emptyResponse: "Sorry, ik kon geen antwoord genereren.",
blockedResponse: "Ik kan dit verzoek niet verwerken. Reden:",
finishReasonSafety: "Het antwoord is geblokkeerd omdat de inhoud als onveilig werd beschouwd. Pas je vraag aan.",
finishReasonRecitation: "Het antwoord is geblokkeerd om herhaling van mogelijk auteursrechtelijk beschermde inhoud te voorkomen. Probeer je verzoek anders te formuleren.",
finishReasonOther: "Het antwoord kon om een onbekende reden niet worden voltooid. Probeer het opnieuw.",
finishReasonProhibited: "Het antwoord is geblokkeerd omdat het verboden inhoud bevatte.",
imageBlocked: "\n\n*(Let op: er is een afbeelding gegenereerd, maar deze kon niet worden weergegeven vanwege inhoudsbeperkingen.)*"
}
};
let T; // Active translation object

// DOM Elementen
const pageTitle = document.getElementById('page-title');
const settingsBtn = document.getElementById('settings-btn');
const settingsModal = document.getElementById('settings-modal');
const saveSettingsBtn = document.getElementById('save-settings-btn');
const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
const apiKeyInput = document.getElementById('api-key-input');
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const chatContainer = document.getElementById('chat-container');
const imageInput = document.getElementById('image-input');
const imagePreviewContainer = document.getElementById('image-preview-container');
const imagePreviewWrapper = document.getElementById('image-preview-wrapper');
const fullscreenModal = document.getElementById('fullscreen-modal');
const fullscreenImage = document.getElementById('fullscreen-image');
const closeFullscreenBtn = document.getElementById('close-fullscreen-btn');

// Variabelen
let apiKey = '';
let currentFiles = []; // AANGEPAST: Structuur is nu [{id, file}, {id, file}, ...]
const chatHistory = [];
const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent';

// --- Functions ---

function setLanguage() {
    const lang = navigator.language.split('-')[0];
    document.documentElement.lang = lang;
    T = (lang === 'nl') ? translations.nl : translations.en;

    document.title = T.pageTitle;
    settingsBtn.title = T.settingsBtnTitle;
    document.getElementById('settings-title').textContent = T.settingsTitle;
    document.getElementById('settings-label').textContent = T.settingsLabel;
    apiKeyInput.placeholder = T.apiKeyPlaceholder;
    cancelSettingsBtn.textContent = T.cancel;
    saveSettingsBtn.textContent = T.save;
    document.getElementById('upload-label').title = T.uploadLabelTitle;
    document.getElementById('send-btn').title = T.sendBtnTitle;
    messageInput.placeholder = T.inputPlaceholder;

    let welcomeMessage = T.welcome_base;
    if (!localStorage.getItem('nanoBananaApiKey')) {
        welcomeMessage += ` ${T.welcome_nokey}`;
    }
    addBotMessage(welcomeMessage);
}

function autoResizeTextarea() {
if (messageInput.value === '') {
messageInput.style.height = '104px';
return;
}
messageInput.style.height = 'auto';
messageInput.style.height = (messageInput.scrollHeight) + 'px';
}

function fileToBase64(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.readAsDataURL(file);
reader.onload = () => {
const encoded = reader.result.toString().replace(/^data:(.*,)?/, '');
resolve({ mimeType: file.type, data: encoded });
};
reader.onerror = error => reject(error);
});
}

async function handleUserMessage() {
    const userMessageText = messageInput.value.trim();
    if (!userMessageText && currentFiles.length === 0) return;

    if (!apiKey) {
        addBotMessage(T.apiKeyNeeded);
        return;
    }

    const userParts = [];
    const imagesForDisplay = [];
    const filesToSend = currentFiles.map(item => item.file);

    if (filesToSend.length > 0) {
        try {
            const conversionPromises = filesToSend.map(file => {
                imagesForDisplay.push(URL.createObjectURL(file));
                return fileToBase64(file);
            });
            const imageBase64Array = await Promise.all(conversionPromises);
            
            imageBase64Array.forEach(imgData => {
                userParts.push({ inlineData: { mimeType: imgData.mimeType, data: imgData.data } });
            });

        } catch (error) {
            console.error("Error converting images:", error);
            addBotMessage(T.imgProcessError);
            return;
        }
    }

    if (userMessageText) {
        userParts.push({ text: userMessageText });
    }

    addUserMessage(userMessageText, imagesForDisplay);
    chatHistory.push({ role: "user", parts: userParts });

    messageInput.value = '';
    clearAllPreviews();
    autoResizeTextarea();

    callNanoBananaAPI();
}


function addUserMessage(message, imageUrls = []) {
    const messageElement = document.createElement('div');
    messageElement.className = 'chat-message user-message';

    let imageHtml = '';
    if (imageUrls.length > 0) {
        imageHtml += '<div class="message-images">';
        imageUrls.forEach(src => {
            imageHtml += `<img src="${src}" alt="Uploaded by user" class="clickable-image">`;
        });
        imageHtml += '</div>';
    }
    
    let textHtml = message ? `<p>${message.replace(/\n/g, '<br>')}</p>` : '';
    
    messageElement.innerHTML = `<div class="message-bubble">${textHtml}${imageHtml}</div>`;
    chatContainer.appendChild(messageElement);
    scrollToBottom();
}


function addBotMessage(textContent, imageObject = null) {
    const messageElement = document.createElement('div');
    messageElement.className = 'chat-message bot-message';
    
    let imageHtml = '';
    if (imageObject && imageObject.data && imageObject.mimeType) {
        imageHtml = `<img src="data:${imageObject.mimeType};base64,${imageObject.data}" alt="Generated Image" class="clickable-image">`;
    }

    let formattedText = textContent
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');
        
    messageElement.innerHTML = `<div class="message-bubble"><p>${formattedText.replace(/\n/g, '<br>')}</p>${imageHtml}</div>`;
    chatContainer.appendChild(messageElement);
    scrollToBottom();
}

function showLoader() {
    const loaderElement = document.createElement('div');
    loaderElement.className = 'chat-message bot-message';
    loaderElement.innerHTML = `<div class="message-bubble loader-bubble"><span>.</span><span>.</span><span>.</span></div>`;
    chatContainer.appendChild(loaderElement);
    scrollToBottom();
    return loaderElement;
}

function updateLoaderWithMessage(loaderElement, textContent, imageObject = null, errorDetails = null) {
    const bubble = loaderElement.querySelector('.message-bubble');
    if (!bubble) return;

    bubble.classList.remove('loader-bubble');

    let imageHtml = '';
    if (imageObject && imageObject.data && imageObject.mimeType) {
        imageHtml = `<img src="data:${imageObject.mimeType};base64,${imageObject.data}" alt="Generated Image" class="clickable-image">`;
    }

    let formattedText = textContent
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');
        
    let errorHtml = '';
    if (errorDetails) {
        bubble.classList.add('error-bubble');
        bubble.dataset.errorDetails = JSON.stringify(errorDetails, null, 2);
        errorHtml = ` <span class="copy-span">${T.copyPrompt}</span>`;
    }
    
    bubble.innerHTML = `<p>${formattedText.replace(/\n/g, '<br>')}${errorHtml}</p>${imageHtml}`;

    scrollToBottom();
}

function scrollToBottom() {
chatContainer.scrollTop = chatContainer.scrollHeight;
}

function openFullscreen(src) {
    fullscreenImage.src = src;
    fullscreenModal.style.display = 'flex';
    history.pushState({modal: 'image'}, '', '#image');
}

function closeFullscreen() {
    if (fullscreenModal.style.display === 'none') return;
    fullscreenModal.style.display = 'none';
    fullscreenImage.src = '';
    if(location.hash === '#image') {
        history.back();
    }
}

// --- NIEUWE FUNCTIES ---
function createPreviewElement(id, file) {
    const wrapper = document.createElement('div');
    wrapper.className = 'preview-image-wrapper';
    wrapper.dataset.id = id;

    const img = document.createElement('img');
    img.title = file.name;
    img.addEventListener('click', () => openFullscreen(img.src));

    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-preview-btn';
    removeBtn.innerHTML = '&times;';
    removeBtn.title = T.removeImgBtnTitle;
    removeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        removeImageById(id);
    });

    const reader = new FileReader();
    reader.onload = (event) => {
        img.src = event.target.result;
    };
    reader.readAsDataURL(file);

    wrapper.appendChild(img);
    wrapper.appendChild(removeBtn);
    imagePreviewWrapper.appendChild(wrapper);
}

function removeImageById(id) {
    currentFiles = currentFiles.filter(item => item.id !== id);
    const elementToRemove = imagePreviewWrapper.querySelector(`.preview-image-wrapper[data-id="${id}"]`);
    if (elementToRemove) {
        elementToRemove.remove();
    }
    if (currentFiles.length === 0) {
        imagePreviewContainer.style.display = 'none';
    }
}

function clearAllPreviews() {
    currentFiles = [];
    imageInput.value = '';
    imagePreviewWrapper.innerHTML = '';
    imagePreviewContainer.style.display = 'none';
}

async function callNanoBananaAPI() {
    const loaderElement = showLoader();
    try {
        const response = await fetch(`${API_URL}?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: chatHistory }),
        });

        const data = await response.json();

        if (!response.ok) {
            const errorMessage = data?.error?.message || T.genericError;
            updateLoaderWithMessage(loaderElement, errorMessage, null, data);
            chatHistory.pop();
            return;
        }

        const candidate = data.candidates?.[0];

        if (candidate) {
            const finishReason = candidate.finishReason;
            if (finishReason && finishReason !== 'STOP' && finishReason !== 'MAX_TOKENS') {
                let reasonMessage = '';
                switch (finishReason) {
                    case 'SAFETY': reasonMessage = T.finishReasonSafety; break;
                    case 'RECITATION': reasonMessage = T.finishReasonRecitation; break;
                    case 'PROHIBITED_CONTENT': reasonMessage = T.finishReasonProhibited; break;
                    default: reasonMessage = T.finishReasonOther;
                }
                updateLoaderWithMessage(loaderElement, reasonMessage, null, data);
                chatHistory.pop();
                return;
            }

            if (candidate.content?.parts) {
                chatHistory.push(candidate.content);
                let responseText = '';
                let responseImage = null;
                
                candidate.content.parts.forEach(part => {
                    if (part.text) {
                        responseText += part.text + '\n';
                    } else if (part.inlineData?.data && part.inlineData?.mimeType) {
                        responseImage = { data: part.inlineData.data, mimeType: part.inlineData.mimeType };
                    }
                });
                
                const hasText = responseText.trim().length > 0;
                const hasImage = responseImage !== null;
                const wasBlockedBySafety = candidate.safetyRatings?.some(r => r.probability !== 'NEGLIGIBLE');
                
                if (hasText && !hasImage && wasBlockedBySafety) {
                    responseText += T.imageBlocked;
                }
                
                updateLoaderWithMessage(loaderElement, responseText.trim(), responseImage);
            } else {
                updateLoaderWithMessage(loaderElement, T.emptyResponse, null, data);
                chatHistory.pop();
            }
        } else if (data.promptFeedback) {
            updateLoaderWithMessage(loaderElement, `${T.blockedResponse} ${data.promptFeedback.blockReason}`, null, data);
            chatHistory.pop();
        } else {
            updateLoaderWithMessage(loaderElement, T.emptyResponse, null, data);
            chatHistory.pop();
            console.error('API returned no candidates and no feedback. Full response:', data);
        }
    } catch (error) {
        console.error('Error calling API:', error);
        const errorData = { error: error.toString(), stack: error.stack };
        updateLoaderWithMessage(loaderElement, T.genericError, null, errorData);
        chatHistory.pop();
    }
}

// --- Event Listeners ---

document.addEventListener('DOMContentLoaded', () => {
setLanguage();
apiKey = localStorage.getItem('nanoBananaApiKey');
if (apiKey) apiKeyInput.value = apiKey;
});

pageTitle.addEventListener('click', () => {
    if (confirm(T.clearChatConfirm)) {
        chatContainer.innerHTML = '';
        chatHistory.length = 0;
        let welcomeMessage = T.welcome_base;
        if (!apiKey) {
            welcomeMessage += ` ${T.welcome_nokey}`;
        }
        addBotMessage(welcomeMessage);
    }
});

settingsBtn.addEventListener('click', () => { settingsModal.style.display = 'flex'; });
cancelSettingsBtn.addEventListener('click', () => { settingsModal.style.display = 'none'; });

saveSettingsBtn.addEventListener('click', () => {
const newApiKey = apiKeyInput.value.trim();
if (newApiKey) {
localStorage.setItem('nanoBananaApiKey', newApiKey);
apiKey = newApiKey;
settingsModal.style.display = 'none';
addBotMessage(T.apiKeySaved);
} else {
alert(T.invalidApiKey);
}
});

chatForm.addEventListener('submit', (e) => { e.preventDefault(); handleUserMessage(); });
messageInput.addEventListener('keydown', (e) => {
if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleUserMessage(); }
});
messageInput.addEventListener('input', autoResizeTextarea);

// AANGEPAST: Event listener voor toevoegen van afbeeldingen
imageInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    if (files.length > 0) {
        files.forEach(file => {
            const id = Date.now() + '-' + file.name;
            currentFiles.push({ id, file });
            createPreviewElement(id, file);
        });
        imagePreviewContainer.style.display = 'block';
    }
    // Belangrijk: reset de input zodat de 'change' event opnieuw kan triggeren
    imageInput.value = '';
});


chatContainer.addEventListener('click', (e) => {
    if (e.target.tagName === 'IMG' && e.target.classList.contains('clickable-image')) {
        openFullscreen(e.target.src);
    }

    const errorBubble = e.target.closest('.error-bubble');
    if (errorBubble && errorBubble.dataset.errorDetails) {
        const copySpan = errorBubble.querySelector('.copy-span');
        if (!copySpan || copySpan.textContent === T.copied) return;

        const detailsToCopy = errorBubble.dataset.errorDetails;
        navigator.clipboard.writeText(detailsToCopy).then(() => {
            const originalText = copySpan.textContent;
            copySpan.textContent = T.copied;
            setTimeout(() => {
                copySpan.textContent = originalText;
            }, 1500);
        }).catch(err => {
            console.error('Failed to copy error details: ', err);
        });
    }
});

closeFullscreenBtn.addEventListener('click', closeFullscreen);
fullscreenModal.addEventListener('click', (e) => {
    if (e.target === fullscreenModal) {
        closeFullscreen();
    }
});

window.addEventListener('popstate', (event) => {
    closeFullscreen();
});

</script>
</body>
</html>