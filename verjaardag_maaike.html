<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maaike's Fantastische Verjaardagskaart Verrassingsmachine!</title>
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh; 
            font-family: 'Comic Sans MS', 'Chalkduster', 'cursive', sans-serif;
            background-color: #FFC0CB; 
            color: #333;
            overflow-x: hidden;
        }

        body {
            padding-top: var(--safe-area-inset-top);
            box-sizing: border-box;
        }

        button, label, input[type="radio"] {
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='pink' stroke='black' stroke-width='1.5'><path d='M14.9 8.6c0-1.9-1.2-3.4-2.8-3.8 -0.2 0-0.3-0.2-0.3-0.4 0-0.4 0.4-0.8 0.8-0.8 0.6 0 1.4 0.2 1.9 0.9 0.5 0.6 0.6 1.4 0.4 2.2C14.9 7.2 14.9 7.9 14.9 8.6zM9.1 8.6c0-1.9 1.2-3.4 2.8-3.8 0.2 0 0.3-0.2 0.3-0.4 0-0.4-0.4-0.8-0.8-0.8 -0.6 0-1.4 0.2-1.9 0.9 -0.5 0.6-0.6 1.4-0.4 2.2C9.1 7.2 9.1 7.9 9.1 8.6zM12 20c-3.6 0-6.5-2.7-6.5-6 0-2.9 2.1-5.4 5-6.2V4c0-0.6 0.4-1 1-1s1 0.4 1 1v3.8c2.9 0.8 5 3.3 5 6.2C18.5 17.3 15.6 20 12 20zM7.7 12c0.2-1.8 1.6-3.3 3.3-3.8V12h-3.3zM13 12V8.2c1.8 0.4 3.1 1.9 3.3 3.8H13z'/><ellipse cx='8' cy='13' rx='1.5' ry='2'/><ellipse cx='12' cy='14' rx='1.5' ry='2'/><ellipse cx='16' cy='13' rx='1.5' ry='2'/><path d='M12,2 C6.477,2 2,6.477 2,12 C2,17.523 6.477,22 12,22 C17.523,22 22,17.523 22,12 C22,6.477 17.523,2 12,2 Z M12,20 C7.582,20 4,16.418 4,12 C4,7.582 7.582,4 12,4 C16.418,4 20,7.582 20,12 C20,16.418 16.418,20 12,20 Z'/><circle cx='6.5' cy='9.5' r='1.5'/><circle cx='9.5' cy='7.5' r='1.5'/><circle cx='14.5' cy='7.5' r='1.5'/><circle cx='17.5' cy='9.5' r='1.5'/></svg>") 16 0, auto !important;
        }

        #settingsView {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px var(--safe-area-inset-right) 30px var(--safe-area-inset-left);
            box-sizing: border-box;
            width: 100%;
        }

        .controls-box {
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.92);
            border-radius: 18px;
            margin-bottom: 20px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 550px;
            box-sizing: border-box;
            text-align: center;
        }

        #cardView {
            display: none;
            width: 100%;
            min-height: calc(100vh - var(--safe-area-inset-top) - var(--safe-area-inset-bottom));
            box-sizing: border-box;
            background-color: #fffaf0; 
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 10px var(--safe-area-inset-right) 10px var(--safe-area-inset-left);
        }
        
        #cardViewTitle {
            font-size: 1.3em;
            color: #E60073;
            margin-top: 5px; 
            margin-bottom: 15px;
            padding: 8px 20px;
            background-color: rgba(255,228,225,0.85); 
            border-radius: 12px;
            text-align: center;
            display: none;
            max-width: 90%;
            flex-shrink: 0;
        }

        #cardContainer {
            width: 100%;
            flex-grow: 1;
            display: flex;
            align-items: stretch;
            justify-content: center;
            box-sizing: border-box;
            min-height: 300px;
        }

        #cardContainer > div {
            max-width: 100%;
            width: 100%;
            min-height: 100%;
            overflow-y: auto;
            box-sizing: border-box;
            border: 3px dashed #FFB6C1;
            border-radius: 15px;
            background-color: #ffffff; 
            padding: 10px;
        }

        #backToSettingsButton {
            position: fixed; 
            width: 60px;
            height: 60px;
            background-color: #FF69B4;
            color: white;
            border: none;
            border-radius: 50%; 
            font-size: 28px; 
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.35);
            z-index: 1001;
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: transform 0.2s ease-out, background-color 0.2s;
            user-select: none; 
            touch-action: none; 
        }
        #backToSettingsButton:hover {
            background-color: #FF1493;
            transform: scale(1.1);
        }
        #backToSettingsButton.dragging {
            cursor: grabbing !important;
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }

        h1 {
            color: #D60069;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: clamp(1.7em, 5vw, 2.1em); /* Iets kleiner voor langere titel */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.15);
        }

        #settingsView p.intro-text {
             margin-bottom: 10px;
             font-size: clamp(1em, 4vw, 1.15em);
             color: #4A4A4A;
             line-height: 1.5;
        }
        #settingsView p.theme-instruction-text {
             margin-top: 15px;
             margin-bottom: 5px;
             font-size: clamp(0.95em, 3.8vw, 1.05em);
             color: #555;
        }


        button#generateThemesButton, button#generateCardButton {
            background: linear-gradient(145deg, #ff79c6, #ff55a3);
            color: white;
            border: none;
            padding: 12px 22px;
            border-radius: 12px;
            font-size: clamp(1em, 4vw, 1.1em);
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(255, 105, 180, 0.4);
        }
        button#generateThemesButton:hover, button#generateCardButton:hover {
            background: linear-gradient(145deg, #ff55a3, #ff79c6);
            transform: translateY(-3px) scale(1.02);
        }
        button#generateThemesButton:disabled, button#generateCardButton:disabled {
            background: #d3d3d3;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        button#generateCardButton {
             animation: pulseGlow 2.5s infinite alternate;
        }
        button#generateCardButton:hover {
            animation-play-state: paused;
        }
         button#generateCardButton:disabled {
            animation: none;
        }


        @keyframes pulseGlow {
            from { transform: scale(1); box-shadow: 0 4px 8px rgba(255, 105, 180, 0.4), 0 0 10px #FFB6C1; }
            to { transform: scale(1.03); box-shadow: 0 6px 12px rgba(255, 105, 180, 0.6), 0 0 20px #FF69B4; }
        }

        #dynamicThemesContainer {
            margin-top: 10px;
            margin-bottom: 15px;
            width: 100%;
        }
        #dynamicThemesContainer label {
            display: flex; 
            align-items: center;
            margin: 8px 0;
            font-size: clamp(0.9em, 3.5vw, 1em);
            text-align: left;
            padding: 10px 15px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            transition: background-color 0.25s, border-color 0.25s, box-shadow 0.25s;
            background-color: #fff;
        }
        #dynamicThemesContainer input[type="radio"] {
            margin-right: 12px;
            vertical-align: middle;
            transform: scale(1.2);
            accent-color: #FF69B4;
        }
        #dynamicThemesContainer input[type="radio"]:checked + span {
            font-weight: bold;
            color: #E60073;
        }
        #dynamicThemesContainer label:has(input[type="radio"]:checked) {
            background-color: #fff0f5;
            border-color: #FFB6C1;
            box-shadow: 0 0 8px rgba(255,182,193,0.5);
        }
        #dynamicThemesContainer label:hover {
            border-color: #FF91A4;
        }


        #themeLoadingMessage, #cardLoadingMessage, #themeErrorMessage, #cardErrorMessage {
            margin-top: 20px;
            font-weight: bold;
            padding: 15px;
            border-radius: 10px;
            font-size: clamp(1em, 4vw, 1.1em);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        #themeLoadingMessage, #cardLoadingMessage { color: #00529B; background-color: #BDE5F8; border: 1px solid #00529B;}
        #themeErrorMessage, #cardErrorMessage { color: #D8000C; background-color: #FFD2D2; border: 1px solid #D8000C;}

        .spinner {
            width: 40px;
            height: 40px;
            border: 5px solid rgba(255, 105, 180, 0.3); 
            border-top-color: #FF1493; 
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 10px auto; 
        }
        #cardLoadingMessage .spinner {
            width: 50px;
            height: 50px;
            border-width: 6px;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #themeLoadingMessage p, #cardLoadingMessage p, #themeErrorMessage p, #cardErrorMessage p { margin: 0;}

    </style>
</head>
<body>
    <div id="settingsView">
        <div class="controls-box">
            <h1>Maaike's Fantastische Verjaardagskaart Verrassingsmachine! ✨</h1>
            <p class="intro-text">Hoi Maaike (en Tobi 🖤🤍)! Klaar voor een unieke, verrassende verjaardagskaart, speciaal van Ries & Kachel?</p>
            
            <button id="generateThemesButton">💡 Verzin Maffe Thema's!</button>
            
            <div id="themeLoadingMessage" style="display: none;">
                <div class="spinner"></div>
                <p>De AI-muze zoekt naar briljante, quirky & absurde thema-ideeën... 🎨</p>
            </div>
            <div id="themeErrorMessage" style="display: none;">
                <p>Oeps! De thema-generator heeft kuren. Probeer het nog eens!</p>
            </div>

            <div id="dynamicThemesContainer">
                <!-- Dynamisch gegenereerde thema's komen hier -->
            </div>
            <p class="theme-instruction-text" style="display: none;">Kies hierboven jouw favoriete AI-gegenereerde thema:</p>

            <button id="generateCardButton" disabled>🎉 Tover mijn Kaart! 🎉</button>
            <div id="cardLoadingMessage" style="display: none;">
                <div class="spinner"></div>
                <p>⏳ De AI-kunstenaars zijn een meesterwerk (of een hilarische puinhoop) aan het brouwen... Een miauwmentje geduld! 😹</p>
            </div>
            <div id="cardErrorMessage" style="display: none;">
                <p>🙀 Oeps! De kaart-AI heeft een haarbal opgehoest. Probeer het nog eens!</p>
            </div>
        </div>
    </div>

    <div id="cardView">
        <div id="cardViewTitle">Jouw kaart met thema: <span></span></div>
        <div id="cardContainer">
            <!-- De gegenereerde kaart komt hier -->
        </div>
    </div>
    <button id="backToSettingsButton">↩️</button> <!-- Simpeler icoon, meer focus op feest in knoppen -->
    
    <script>
        const apiKeys = [
            "AIzaSyA35Q0b3PkCw_EssBhlBqFAE7rH7aZChp8",
            "AIzaSyAJLEzc0a5VjjemC9a5L3bJMHl8jpbArWI",
            "AIzaSyCxmmAQbjU_lqk1nfKY_lbfpjXBdjWXhoE",
            "AIzaSyDipoc_rZsk7s0bFet0XogMpJJL5awxAfc",
            "AIzaSyDWDbPjmvH9_hphsnY_yJGdue42qRMG3do"
        ];
        let currentApiKeyIndex = 0;

        const settingsView = document.getElementById('settingsView');
        const cardView = document.getElementById('cardView');
        const cardViewTitleText = document.getElementById('cardViewTitle').querySelector('span');
        const cardViewTitleDiv = document.getElementById('cardViewTitle');
        
        const generateThemesButton = document.getElementById('generateThemesButton');
        const dynamicThemesContainer = document.getElementById('dynamicThemesContainer');
        const themeInstructionText = document.querySelector('.theme-instruction-text');
        const themeLoadingMessage = document.getElementById('themeLoadingMessage');
        const themeErrorMessage = document.getElementById('themeErrorMessage');

        const generateCardButton = document.getElementById('generateCardButton');
        const cardContainer = document.getElementById('cardContainer');
        const cardLoadingMessage = document.getElementById('cardLoadingMessage');
        const cardErrorMessage = document.getElementById('cardErrorMessage');
        
        const backToSettingsButton = document.getElementById('backToSettingsButton');

        // --- Dragging logic --- 
        let isDragging = false;
        let hasDragged = false;
        let dragInitialButtonLeft, dragInitialButtonTop;
        let dragPointerStartX, dragPointerStartY;

        function initializeButtonPosition() {
            const storedPosition = JSON.parse(localStorage.getItem('backButtonPosition'));
            if (storedPosition && storedPosition.top && storedPosition.left) {
                backToSettingsButton.style.top = storedPosition.top;
                backToSettingsButton.style.left = storedPosition.left;
            } else {
                const safeBottom = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-bottom')) || 0;
                const safeRight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-right')) || 0;
                backToSettingsButton.style.top = `calc(100vh - 70px - ${safeBottom}px)`;
                backToSettingsButton.style.left = `calc(100vw - 70px - ${safeRight}px)`;
            }
        }
        initializeButtonPosition();

        function dragStart(e) {
            isDragging = true;
            hasDragged = false;
            backToSettingsButton.classList.add('dragging');
            dragInitialButtonLeft = backToSettingsButton.offsetLeft;
            dragInitialButtonTop = backToSettingsButton.offsetTop;
            dragPointerStartX = e.type === "touchstart" ? e.touches[0].clientX : e.clientX;
            dragPointerStartY = e.type === "touchstart" ? e.touches[0].clientY : e.clientY;
            if (e.type !== "touchstart") { backToSettingsButton.style.cursor = 'grabbing';}
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            hasDragged = true;
            let pointerCurrentX = e.type === "touchmove" ? e.touches[0].clientX : e.clientX;
            let pointerCurrentY = e.type === "touchmove" ? e.touches[0].clientY : e.clientY;
            let pointerDeltaX = pointerCurrentX - dragPointerStartX;
            let pointerDeltaY = pointerCurrentY - dragPointerStartY;
            let newLeft = dragInitialButtonLeft + pointerDeltaX;
            let newTop = dragInitialButtonTop + pointerDeltaY;
            const btnRect = backToSettingsButton.getBoundingClientRect();
            const safeTop = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-top')) || 0;
            const safeBottom = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-bottom')) || 0;
            const safeLeft = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-left')) || 0;
            const safeRight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-right')) || 0;
            const minTop = safeTop + 10;
            const maxTop = window.innerHeight - btnRect.height - safeBottom - 10;
            const minLeft = safeLeft + 10;
            const maxLeft = window.innerWidth - btnRect.width - safeRight - 10;
            newTop = Math.max(minTop, Math.min(newTop, maxTop));
            newLeft = Math.max(minLeft, Math.min(newLeft, maxLeft));
            backToSettingsButton.style.top = `${newTop}px`;
            backToSettingsButton.style.left = `${newLeft}px`;
        }
        
        function dragEnd(e) {
            if (!isDragging) return;
            isDragging = false;
            backToSettingsButton.classList.remove('dragging');
            if (e.type !== "touchend") { backToSettingsButton.style.cursor = ''; }
            localStorage.setItem('backButtonPosition', JSON.stringify({ top: backToSettingsButton.style.top, left: backToSettingsButton.style.left }));
        }

        backToSettingsButton.addEventListener("mousedown", dragStart);
        backToSettingsButton.addEventListener("touchstart", dragStart, {passive: false});
        document.addEventListener("mousemove", drag);
        document.addEventListener("touchmove", drag, {passive: false});
        document.addEventListener("mouseup", dragEnd);
        document.addEventListener("touchend", dragEnd);
        // --- End Dragging logic ---

        async function fetchAIResponse(promptText, generationConfig) {
            let apiKey = apiKeys[currentApiKeyIndex];
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }],
                    generationConfig: generationConfig
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                let msg = `API fout: ${response.status}. `;
                if (errorData.error && errorData.error.message) msg += errorData.error.message;
                currentApiKeyIndex = (currentApiKeyIndex + 1) % apiKeys.length; // Probeer volgende key bij fout
                console.warn(`API key gefaald, volgende key wordt ${apiKeys[currentApiKeyIndex]}`);
                throw new Error(msg + ` (Probeert nu API key ${currentApiKeyIndex +1})`);
            }
            return await response.json();
        }

        generateThemesButton.addEventListener('click', async () => {
            themeLoadingMessage.style.display = 'flex';
            themeErrorMessage.style.display = 'none';
            dynamicThemesContainer.innerHTML = ''; 
            generateThemesButton.disabled = true;
            generateCardButton.disabled = true; 
            themeInstructionText.style.display = 'none';

            const themePrompt = `
Je bent een AI die gespecialiseerd is in het bedenken van creatieve, humoristische, en originele thema's voor verjaardagskaarten.
Maaike wordt 26 jaar en heeft een zwart-witte kat genaamd Tobi. Ze houdt van humor die quirky, maf, grappig, absurdistisch en/of een tikkeltje fout is.
Genereer een lijst van 4 unieke, korte, en pakkende thema-titels voor haar verjaardagskaart.
De thema's moeten deze brede humoristische stijl reflecteren, eventueel Tobi of haar leeftijd (26) speels benoemen, en een hint geven naar een mogelijke visuele stijl of sfeer.
Geef de uitvoer als een JSON-array van strings. Zorg dat elke string in de array een uniek thema is.
Voorbeeld van het type output (maar wees origineler!): ["Tobi's Interdimensionale Kattenkruid Avontuur", "Maaike's Maffe Muffin Mysterie (26 smaken!)", "De Grote Verjaardags-Grap van de Vliegende Spaghettimonsters", "Quirky Kwantumkatten en de Confetti Kosmos van 26 Lichtjaar"]
De thema's moeten uitnodigend, grappig en een beetje absurd klinken.
`;
            try {
                const data = await fetchAIResponse(themePrompt, {
                    "temperature": 0.9, "maxOutputTokens": 512, "topP": 0.98, "topK": 50 // Iets hogere TopK voor meer variatie
                });

                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    let themesText = data.candidates[0].content.parts[0].text;
                    themesText = themesText.replace(/^```json\s*/i, '').replace(/\s*```$/, '').trim();
                    
                    let themesArray;
                    try {
                        themesArray = JSON.parse(themesText);
                        if (!Array.isArray(themesArray) || themesArray.some(t => typeof t !== 'string')) {
                            throw new Error("AI gaf geen valide JSON-lijst met thema's (geen array van strings).");
                        }
                    } catch (e) {
                        console.error("Fout bij parsen van thema's JSON:", e, "Ontvangen tekst:", themesText);
                        themesArray = themesText.split(/\n\s*(?:\d+\.\s*|-\s*|\*\s*)/)
                                            .map(line => line.trim().replace(/^["']|["']$/g, ''))
                                            .filter(line => line.length > 3 && line.length < 100); 
                        if (themesArray.length === 0) {
                             throw new Error("AI gaf geen bruikbare lijst met thema's. Probeer het opnieuw.");
                        }
                    }

                    themesArray.forEach((theme, index) => {
                        const label = document.createElement('label');
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = 'dynamicTheme';
                        input.value = theme;
                        input.id = `theme-${index}`;
                        if (index === 0) input.checked = true;

                        const span = document.createElement('span');
                        span.textContent = theme;

                        label.appendChild(input);
                        label.appendChild(span);
                        dynamicThemesContainer.appendChild(label);

                        input.addEventListener('change', () => {
                            generateCardButton.disabled = !document.querySelector('input[name="dynamicTheme"]:checked');
                            document.querySelectorAll('#dynamicThemesContainer label').forEach(l => {
                                l.style.backgroundColor = '#fff'; l.style.borderColor = '#f0f0f0'; l.style.boxShadow = 'none';
                            });
                            if(input.checked) {
                                label.style.backgroundColor = '#fff0f5'; label.style.borderColor = '#FFB6C1'; label.style.boxShadow = '0 0 8px rgba(255,182,193,0.5)';
                            }
                        });
                    });
                    if (themesArray.length > 0) {
                        document.getElementById('theme-0').dispatchEvent(new Event('change'));
                        themeInstructionText.style.display = 'block';
                    } else {
                         generateCardButton.disabled = true;
                    }

                } else {
                    throw new Error("De AI kon geen thema's verzinnen. De muze is blijkbaar nog aan het ontbijten!");
                }

            } catch (error) {
                console.error('Fout bij genereren thema\'s:', error);
                themeErrorMessage.innerHTML = `<p>🙀 Oeps! ${error.message}</p>`;
                themeErrorMessage.style.display = 'flex';
            } finally {
                themeLoadingMessage.style.display = 'none';
                generateThemesButton.disabled = false;
            }
        });

        generateCardButton.addEventListener('click', generateCard);
        
        backToSettingsButton.addEventListener('click', () => {
            if (hasDragged) { hasDragged = false; return; }
            showSettingsView();
        });
        
        function showSettingsView() {
            cardView.style.display = 'none';
            backToSettingsButton.style.display = 'none';
            cardViewTitleDiv.style.display = 'none';
            settingsView.style.display = 'flex';
            document.body.style.backgroundColor = '#FFC0CB';
        }

        function showCardView(htmlContent, themeName) {
            cardContainer.innerHTML = htmlContent;
            cardViewTitleText.textContent = themeName;
            cardViewTitleDiv.style.display = 'block';
            settingsView.style.display = 'none';
            cardView.style.display = 'flex'; 
            backToSettingsButton.style.display = 'flex'; 
            document.body.style.backgroundColor = '#fffaf0';
            initializeButtonPosition();
        }

        async function generateCard() {
            const selectedThemeRadio = document.querySelector('input[name="dynamicTheme"]:checked');
            if (!selectedThemeRadio) {
                alert('Kies eerst een thema, feestbeest!');
                return;
            }
            const selectedTheme = selectedThemeRadio.value;

            cardLoadingMessage.style.display = 'flex';
            cardErrorMessage.style.display = 'none';
            generateCardButton.disabled = true;
            generateThemesButton.disabled = true;

            const cardPrompt = `
Je bent een uitzonderlijk creatieve en humoristische AI, gespecialiseerd in het ontwerpen van unieke, HTML verjaardagskaarten met inline CSS voor Maaike.
Genereer een HTML verjaardagskaart voor Maaike, die haar 26e verjaardag viert.
De output moet UITSLUITEND HTML-code zijn voor de kaart. Begin direct met de buitenste \`<div>\` tag en eindig met de bijbehorende \`</div>\`. Geen markdown, geen uitleg, alleen de pure HTML-structuur van de kaart.
De kaart moet visueel aantrekkelijk, super feestelijk zijn. De inhoud moet schalen/rangschikken binnen de kaart-div.

**BELANGRIJKE INFORMATIE VOOR DE KAART (VOLG DIT NAUWKEURIG!):**
1.  **ONTVANGER:** Maaike, viert haar 26e verjaardag. Haar leeftijd (26 jaar) moet prominent en feestelijk genoemd worden.
2.  **AFZENDERS (EXTREEM BELANGRIJK!):** De felicitaties en de kaart zijn **UITSLUITEND** van **Richard (zijn roepnaam is Ries)** en **zijn kat Kachel**. Vermeld hen duidelijk, liefst aan het einde, als de afzenders. Bijvoorbeeld: "Liefs van Ries en een pootje van Kachel!" of "Van je vrienden, Richard & Kachel de kat."
3.  **MAAIKE'S KAT (GEEN AFZENDER!):** Maaike heeft een geliefde **zwart-witte kat genaamd Tobi**. Tobi is onderdeel van Maaike's leven en haar verjaardagsfeest. Tobi MOET een leuke, centrale rol spelen in het *ontwerp* en de *boodschap* van de kaart (bijvoorbeeld als vrolijke metgezel van Maaike, een grappig element, of iets dat Maaike en Tobi samen doen op haar verjaardag). **TOBI IS ABSOLUUT GEEN AFZENDER VAN DE KAART.** De kaart is NIET van Tobi.
4.  **TOON:** Maaike houdt van humor die **quirky, maf, grappig, absurdistisch, en/of een tikkeltje fout** is. De kaart moet deze sfeer uitstralen. Wees creatief, origineel en grappig!

**GEKOZEN THEMA (door AI bedacht, door Maaike gekozen):** "${selectedTheme}"
Laat dit thema de leidraad zijn voor de hele kaart! Verwerk dit thema prominent en creatief in het ontwerp, de tekst, de kleuren, de sfeer, en eventuele (CSS-gesuggereerde) afbeeldingen. Denk out-of-the-box om dit thema tot leven te brengen op een quirky, maffe, grappige, absurde, foute en feestelijke manier voor Maaike. Zorg dat het thema duidelijk herkenbaar is.

**TECHNISCHE VEREISTEN VOOR DE KAART-HTML:**
- Alle styling MOET inline CSS zijn (\`style\` attribuut). Geen \`<style>\` tags, externe CSS, of JavaScript.
- **GEEN EXTERNE AFBEELDINGEN:** Gebruik GEEN \`<img>\` tags met externe URLs. Creëer visuals met pure CSS of beschrijf ze levendig.
- De buitenste \`<div>\` van de kaart moet: \`width: 100%; height: 100%; box-sizing: border-box; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: space-around; text-align: center; padding: 15px; font-family: 'Comic Sans MS', 'Chalkduster', cursive, sans-serif;\`. Je mag \`justify-content\` aanpassen.
- Gebruik gangbare lettertypes met fallbacks. Zorg voor leesbare tekst en goed contrast.
- De kaart moet een duidelijke felicitatie aan Maaike bevatten (bv. "Lieve Maaike, van harte gefeliciteerd met je fantastische 26e verjaardag!"), de afzenders (Richard/Ries & Kachel) duidelijk noemen, en Tobi (Maaike's kat) op een passende, leuke manier integreren in het thema/verhaal van de kaart, **maar Tobi NIET als afzender opvoeren.**

Laat het gekozen thema "${selectedTheme}" exploderen in een feest van originele, maffe en grappige fun voor Maaike's 26e, van Ries & Kachel!
`;

            try {
                const data = await fetchAIResponse(cardPrompt, {
                    "temperature": 0.88, "maxOutputTokens": 8192, "topP": 0.95, "topK": 45 // Iets hogere temp en topK
                });

                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    let htmlContent = data.candidates[0].content.parts[0].text;
                    htmlContent = htmlContent.replace(/^```html\s*/i, '').replace(/\s*```$/, '').trim();
                    const divStartIndex = htmlContent.toLowerCase().indexOf('<div');
                    const divEndIndex = htmlContent.toLowerCase().lastIndexOf('</div>');

                    if (divStartIndex !== -1 && divEndIndex > divStartIndex) {
                        htmlContent = htmlContent.substring(divStartIndex, divEndIndex + 6);
                    } else if (divStartIndex !== -1) {
                        htmlContent = htmlContent.substring(divStartIndex);
                    } else if (!htmlContent.trim()) {
                        throw new Error("De AI gaf een mysterieuze lege kaart terug. Probeer een andere magie!");
                    }
                    showCardView(htmlContent, selectedTheme);
                } else {
                    let noCandidateReason = "Onbekende reden (kaart)";
                    if (data.promptFeedback?.blockReason) {
                        noCandidateReason = `Generatie kaart geblokkeerd: ${data.promptFeedback.blockReason}. Details: ${JSON.stringify(data.promptFeedback.safetyRatings)}`;
                    } else if (!data.candidates || data.candidates.length === 0) {
                        noCandidateReason = "De AI is even de kluts kwijt voor de kaart. Misschien te veel kattenkruid?";
                    }
                    throw new Error(`Geen kaart gegenereerd. ${noCandidateReason}`);
                }

            } catch (error) {
                console.error('Fout tijdens kaartgeneratie:', error);
                cardErrorMessage.innerHTML = `<p>🙀 Oeps! ${error.message}</p>`;
                cardErrorMessage.style.display = 'flex';
            } finally {
                cardLoadingMessage.style.display = 'none';
                generateCardButton.disabled = !document.querySelector('input[name="dynamicTheme"]:checked');
                generateThemesButton.disabled = false;
            }
        }
    </script>
</body>
</html>
